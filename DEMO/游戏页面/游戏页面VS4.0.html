<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="page_title">Coffee Supply Chain Simulation Game</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Inria Serif', serif;
      background: #f8f0e3;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #495057;
    }
    .search-container {
      display: flex;
      align-items: center;
      margin-top: 32px;
      margin-bottom: 16px;
      max-width: 500px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* 回合计数器样式 */
    .round-counter-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 32px;
      margin-bottom: 16px;
      width: 100%;
    }
    
    .round-counter {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffffff;
      background: #333333;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      user-select: none;
      letter-spacing: 1px;
      border: 2px solid #333333;
      padding: 8px 16px;
      min-width: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .round-counter:hover {
      color: #ffffff;
      background: #333333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 12px 24px rgba(0, 0, 0, 0.2);
    }
    
    .round-counter:active {
      background: #333333;
      color: #ffffff;
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .search-input {
      flex: 1;
      height: 50px;
      border-radius: 25px;
      border: 1px solid #e0e0e0;
      background-color: #f5f5f5;
      padding: 0 20px;
      font-size: 1rem;
      color: #333;
      margin-right: 10px;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      border-color: #333;
      background-color: #fff;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
    }
    
    .month-bar {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffffff;
      background: #333333;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      user-select: none;
      letter-spacing: 1px;
      border: 2px solid #333333;
      padding: 8px 16px;
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .month-bar:hover {
      color: #ffffff;
      background: #333333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 12px 24px rgba(0, 0, 0, 0.2);
    }
    .month-bar:active {
      background: #333333;
      color: #ffffff;
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .main-panel {
      margin-top: 16px;
      display: flex;
      flex-direction: row;
      gap: 24px;
      justify-content: space-between;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
      align-items: flex-start;
    }
    .module {
      background: #ffffff;
      border-radius: 16px;
      width: 340px;
      min-width: 280px;
      max-width: 360px;
      height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06), 0 16px 32px rgba(0, 0, 0, 0.04);
      padding: 16px;
      margin: 0;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .module:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06), 0 12px 24px rgba(0, 0, 0, 0.08), 0 24px 48px rgba(0, 0, 0, 0.06);
    }
    .module-building {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 120px;
      background: #f8f9fa;
      border-radius: 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .module-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06);
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .module-image:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06), 0 12px 24px rgba(0, 0, 0, 0.08), 0 24px 48px rgba(0, 0, 0, 0.06);
      border-color: #ced4da;
    }
    .module-info-panel {
      width: 100%;
      min-height: 120px;
      background: #f8f9fa;
      border-radius: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 4px 8px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 0 16px 0;
      position: relative;
      z-index: 2;
      border: 1px solid #e9ecef;
    }
    .module-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #212529;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
      font-family: 'Inria Serif', serif;
    }
    .module-label {
      font-size: 1.08rem;
      color: #6c757d;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
      font-family: 'Inria Serif', serif;
    }
    .module-value {
      font-size: 2.3rem;
      font-weight: 700;
      color: #2f80ed;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      margin-top: 8px;
      margin-bottom: 0;
      font-family: 'Inria Serif', serif;
    }
    .unit-label {
      font-size: 1.1rem;
      color: #adb5bd;
      font-weight: 500;
      margin-left: 2px;
      letter-spacing: 0.5px;
      font-family: 'Inria Serif', serif;
    }
    
    /* Factory模块特殊样式 */
    .factory-module {
      position: relative;
      overflow: hidden;
      width: 380px;
      height: 202px;
    }
    
    .factory-background-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0.6;
      transition: all 0.3s ease;
      filter: brightness(0.7) contrast(1.1);
    }
    
    .factory-module:hover .factory-background-image {
      opacity: 0.85;
      transform: scale(1.05);
      filter: brightness(0.6) contrast(1.5);
    }
    
    .factory-content {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      min-height: 240px;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 0 12px 0;
    }
    
    /* Factory模块专用文字样式 */
    .factory-module .module-title {
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: 800;
    }
    
    .factory-module .module-label {
      color: #f8f9fa;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }
    
    .factory-module .module-value {
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: 800;
    }
    
    .factory-module .unit-label {
      color: #e9ecef;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }
    
    /* Distributor模块特殊样式 */
    .distributor-module {
      position: relative;
      overflow: hidden;
      width: 380px;
      height: 202px;
    }
    
    .distributor-background-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0.6;
      transition: all 0.3s ease;
      filter: brightness(0.7) contrast(1.1);
    }
    
    .distributor-module:hover .distributor-background-image {
      opacity: 0.85;
      transform: scale(1.05);
      filter: brightness(0.6) contrast(1.5);
    }
    
    .distributor-content {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      min-height: 240px;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 0 12px 0;
    }
    
    /* Distributor模块专用文字样式 */
    .distributor-module .module-title {
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: 800;
    }
    
    .distributor-module .module-label {
      color: #f8f9fa;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }
    
    .distributor-module .module-value {
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: 800;
    }
    
    .distributor-module .unit-label {
      color: #e9ecef;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }
    
    /* Consumer模块特殊样式 */
    .consumer-module {
      position: relative;
      overflow: hidden;
      width: 360px;
      height: 202px;
    }
    
    .consumer-background-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0.6;
      transition: all 0.3s ease;
      filter: brightness(0.7) contrast(1.1);
    }
    
    .consumer-module:hover .consumer-background-image {
      opacity: 0.85;
      transform: scale(1.05);
      filter: brightness(0.6) contrast(1.5);
    }
    
    .consumer-content {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      min-height: 240px;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 0 16px 0;
    }
    
    /* Consumer模块专用文字样式 */
    .consumer-module .module-title {
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: 800;
    }
    
    .consumer-module .module-label {
      color: #f8f9fa;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }
    
    .consumer-module .module-value {
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: 800;
    }
    
    .consumer-module .unit-label {
      color: #e9ecef;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }
    
    /* 底部面板区域 */
    .bottom-row-flex {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: space-between;
      width: 100%;
      gap: 20px;
      margin-top: var(--spacing-xl);
      padding: 0 var(--spacing-md);
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
      padding-left: 20px;
    }

    /* 通用面板样式 */
    .panel, .event-panel {
      background: #ffdaa6;
      border-radius: 16px;
      border: 6px solid #ffdaa6;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06), 0 16px 32px rgba(0, 0, 0, 0.04);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    /* ChatGPT面板卡片样式 */
    .ai-panel {
      background: #000000;
      border-radius: 20px;
      border: 2px solid #333333;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1), 0 8px 16px rgba(255, 255, 255, 0.06), 0 16px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      overflow: hidden;
      position: relative;
    }

    .panel::before, .event-panel::before, .ai-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      border-radius: 16px 16px 0 0;
    }

    .panel:hover, .event-panel:hover, .ai-panel:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06), 0 12px 24px rgba(0, 0, 0, 0.08), 0 24px 48px rgba(0, 0, 0, 0.06), 0 20px 40px -12px rgba(0, 0, 0, 0.2);
    }

    /* 控制面板 - Data Dashboard，高度与其他面板对齐 */
    .panel {
      width: 360px;
      min-height: 420px;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      justify-content: flex-start;
      margin-left: -50px;
    }
    
    /* Panel标题头部样式 */
    .panel-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center; /* Changed back to center */
      padding: 16px 24px 16px 24px; /* Adjusted padding-left to original value */
      background: #ffdaa6;
      min-height: 64px;
      box-sizing: border-box;
      border-radius: 16px 16px 0 0;
      position: relative; /* Added position relative */
    }
    
    .panel-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #000000;
      letter-spacing: 1px;
      margin: 0;
      text-align: center;
    }
    
    /* Panel内容区域样式 */
    .panel-content {
      flex: 1;
      padding: var(--spacing-xl) var(--spacing-xl) var(--spacing-xl) calc(var(--spacing-xl) + 25px);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      justify-content: space-between;
      background: #ffdaa6;
    }
    
    .panel-history-bar {
      position: absolute;
      top: 78px;
      right: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      z-index: 2;
    }

    .history-label {
      color: var(--gray-600);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .history-btn {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      cursor: pointer;
      padding: var(--spacing-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-lg);
      transition: all 0.2s ease;
      width: 36px;
      height: 36px;
    }

    .history-btn:hover {
      background: var(--primary-light);
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .cost-block {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-xl) var(--spacing-lg);
      background: #ffdaa6;
      border-radius: var(--radius-xl);
      border: 1px solid var(--gray-200);
    }

    .cost-title {
      color: var(--gray-900);
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
    }

    .cost-value {
      color: #00a651;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: var(--spacing-lg);
      letter-spacing: -0.025em;
    }
    .panel-row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      width: 100%;
      margin-bottom: var(--spacing-lg);
    }

    .panel-label {
      font-size: 1rem;
      color: #000000;
      font-weight: 600;
      margin-left: 15px;
    }

    .panel-input {
      width: 240px;
      height: 52px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      font-size: 1.05rem;
      text-align: center;
      font-family: inherit;
      background: #ffffff;
      color: #2d3748;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0 20px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin: 0 auto;
    }

    .panel-input:focus {
      outline: none;
      border-color: #4299e1;
      background: #ffffff;
      box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.15);
      transform: translateY(-1px);
    }

    .panel-input:hover {
      border-color: #cbd5e0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }

    .panel-btn {
      margin: 16px 16px 16px 16px; /* 添加外边距，与模块边框保持距离 */
      width: calc(100% - 32px); /* 调整宽度以适应新的边距 */
      height: 56px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #4a4a4a; /* 添加灰色边框，与模块黑色边框区分 */
      border-radius: var(--radius-xl);
      font-size: 1.125rem;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-lg);
      letter-spacing: 0.025em;
      position: relative;
      overflow: hidden;
      padding: 8px 16px; /* 添加内边距，增强按钮内部空间感 */
    }

    .panel-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .panel-btn:hover::before {
      left: 100%;
    }

    .panel-btn:disabled {
      background: var(--gray-400);
      cursor: not-allowed;
      box-shadow: none;
    }

    .panel-btn:hover:not(:disabled) {
      background: #333333;
      border-color: #666666; /* 悬停时边框颜色变亮，增强交互反馈 */
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .panel-btn:active:not(:disabled) {
      transform: translateY(0);
      border-color: #888888; /* 点击时边框颜色进一步变亮 */
      box-shadow: var(--shadow-md); /* 点击时阴影减小，增强按下效果 */
    }
    .last-round-row {
      margin-bottom: var(--spacing-md);
    }

    .last-label {
      color: #000000;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .last-value {
      color: var(--gray-800);
      font-size: 1rem;
      font-weight: 700;
      text-align: right;
      font-family: inherit;
    }
    .history-modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .history-mask {
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
    .history-content {
      position: relative;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      width: 600px;
      max-width: 96vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      padding: 0 0 10px 0;
      z-index: 1;
      border: 1px solid #e9ecef;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 16px 8px 16px;
      font-size: 1.12rem;
      font-weight: 700;
      color: #212529;
      letter-spacing: 0.5px;
    }
    .history-close {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      font-size: 1.4rem;
      color: #6c757d;
      cursor: pointer;
      margin-left: 8px;
      border-radius: 50%;
      transition: all 0.18s;
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
    }
    .history-close:hover {
      background: #e9ecef;
      transform: scale(1.1);
    }
    .history-table-wrap {
      overflow-y: auto;
      max-height: 32vh;
      padding: 0 14px;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.08rem;
    }
    .history-table th, .history-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #e9ecef;
      text-align: center;
      color: #495057;
    }
    .history-table th {
      background: #f8f9fa;
      color: #2f80ed;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 1;
      letter-spacing: 0.5px;
    }
    .history-table tr:nth-child(even) td {
      background: #f8f9fa;
    }
    .history-table tr:nth-child(odd) td {
      background: #ffffff;
    }
    @media (max-width: 1100px) {
      .main-panel { transform: scale(1); gap: 16px; max-width: 100vw; }
      .panel { width: 360px; min-width: 360px; padding: 0; }
      .module { width: 280px; min-width: 280px; }
      .history-content { width: 98vw; }
      .month-bar { width: 98vw; }
    }
    .number-animate {
      animation: popNumber 0.38s cubic-bezier(.4,1.6,.6,1);
    }
    @keyframes popNumber {
      0% { transform: scale(1); background: #fff; }
      30% { transform: scale(1.08); background: #f5f5f3; }
      60% { transform: scale(0.98); background: #faf9f6; }
      100% { transform: scale(1); background: #fff; }
    }
    .bottom-flex {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
      gap: 36px;
    }
    .android-card-demo {
      width: 170px;
      min-width: 120px;
      max-width: 200px;
      height: 220px;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .android-svg-bg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .android-svg-label {
      position: absolute;
      left: 0; right: 0;
      top: 38px;
      text-align: center;
      font-family: 'Abhaya Libre', 'Inria Serif', serif;
      font-size: 1.1rem;
      color: #000;
      font-weight: 700;
      letter-spacing: 0.5px;
      pointer-events: none;
    }
    .android-svg-ellipse {
      position: absolute;
      left: 18px;
      top: 28px;
      width: 22px;
      height: 22px;
      z-index: 2;
    }
    .android-svg-flag {
      position: absolute;
      left: 28px;
      top: 60px;
      width: 17px;
      height: 15px;
      z-index: 2;
    }
    .android-svg-building {
      position: absolute;
      left: 18px;
      top: 110px;
      width: 20px;
      height: 17px;
      z-index: 2;
    }
    .android-svg-warning {
      position: absolute;
      right: 18px;
      top: 18px;
      width: 16px;
      height: 15px;
      z-index: 2;
    }
    .android-svg-arrow {
      position: absolute;
      right: 12px;
      top: 80px;
      width: 28px;
      height: 31px;
      z-index: 2;
    }
    .android-svg-label2 {
      position: absolute;
      left: 0; right: 0;
      top: 70px;
      text-align: center;
      font-family: 'Abhaya Libre', 'Inria Serif', serif;
      font-size: 0.9rem;
      color: #000;
      font-weight: 400;
      pointer-events: none;
    }
    .android-svg-label3 {
      position: absolute;
      left: 0; right: 0;
      top: 120px;
      text-align: center;
      font-family: 'Abhaya Libre', 'Inria Serif', serif;
      font-size: 0.9rem;
      color: #000;
      font-weight: 400;
      pointer-events: none;
    }
    @media (max-width: 900px) {
      .bottom-flex { flex-direction: column; align-items: center; gap: 16px; }
      .android-card-demo { width: 98vw; min-width: 0; height: 120px; }
    }
    /* 三列底部flex布局 */
    .bottom-row-flex {
      display: flex;
      flex-direction: row;
      align-items: stretch; /* 改为stretch使所有面板等高 */
      justify-content: flex-start;
      width: 100%;
      gap: 56px;
      margin-top: 28px;
      padding-left: 160px;
    }
    .panel-placeholder {
      /* 使底部panel与两侧装饰区的间距与顶部一致 */
      width: 240px;
      height: 100%;
      background: #f3f3f3;
      border-radius: 16px;
      border: 1px solid #e3e2e0;
      min-height: 420px;
    }
    /* 新增panel-blank样式 */
    .panel-blank {
      width: 280px;
      height: 100%;
      background: #f3f3f3;
      border-radius: 16px;
      border: 1px solid #e3e2e0;
      min-height: 420px;
      box-sizing: border-box;
    }
    /* 新增事件面板样式 - Incident System，融合为一个统一框架 */
.event-panel {
  width: 345px;
  min-height: 0;
  background: #f5f5f5;
  border-radius: 16px;
  border: 6px solid #666666;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06), 0 16px 32px rgba(0, 0, 0, 0.04);
  font-family: 'Inria Serif', 'Arial', sans-serif;
  position: relative;
  margin: 0;
  margin-right: 44px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  padding: 16px 12px 12px 12px;
  gap: 8px;
  overflow: hidden;
  transition: all 0.2s ease;
}
.event-panel:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06), 0 12px 24px rgba(0, 0, 0, 0.08), 0 24px 48px rgba(0, 0, 0, 0.06);
  border-color: #333333;
  border-width: 6px;
  transform: translateY(-2px);
}

/* 事件面板融合样式 - 移除分割线，统一为一个整体 */
.event-panel-header {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  border-bottom: none;
  background: transparent;
  min-height: auto;
  box-sizing: border-box;
  position: relative;
}

.event-panel-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #000000;
  letter-spacing: 1px;
  margin: 0;
}

.event-panel-decoration {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 16px;
  background: #f0f7ff;
  border: 1px solid #e1f0ff;
  position: absolute;
  right: 0;
}

.event-panel-footer {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  border-top: none;
  background: transparent;
  min-height: auto;
  box-sizing: border-box;
  margin-top: auto;
}

.event-status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: #f8f9fa;
  border-radius: 12px;
  border: 1px solid #e9ecef;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #2f80ed;
  animation: pulse 2s infinite;
}

.status-text {
  font-size: 0.9rem;
  color: #6c757d;
  font-weight: 500;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
    .event-title {
      font-size: 1.18rem;
      font-weight: 700;
      color: #4ecdc4;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .event-desc {
      font-size: 1.05rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 18px;
      line-height: 1.6;
    }
    .event-effect {
      font-size: 1rem;
      color: #ff6b6b;
      margin-bottom: 18px;
      font-weight: 600;
    }
    .event-close-btn {
      position: absolute;
      top: 12px;
      right: 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 1.4rem;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      border-radius: 50%;
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .event-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      transform: scale(1.1);
    }
    /* New Event System Modal Styles */
    .event-modal-mask {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.60);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    .event-modal {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e9ecef;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      padding: 32px 32px 24px 32px;
      min-width: 320px;
      max-width: 92vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
      z-index: 2001;
      font-family: 'Inria Serif', serif;
      animation: popNumber 0.38s cubic-bezier(.4,1.6,.6,1);
    }
    .event-modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #212529;
      margin-bottom: 16px;
      letter-spacing: 0.5px;
    }
    .event-modal-desc {
      font-size: 1.08rem;
      color: #6c757d;
      margin-bottom: 18px;
      line-height: 1.7;
    }
    .event-modal-effect {
      font-size: 1.05rem;
      color: #2f80ed;
      margin-bottom: 18px;
      font-weight: 600;
    }
    .event-modal-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      font-size: 1.4rem;
      color: #6c757d;
      cursor: pointer;
      border-radius: 50%;
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .event-modal-close:hover {
      background: #e9ecef;
      color: #495057;
      transform: scale(1.1);
    }
    /* ---- 动画覆盖层基础样式 ---- */
    .overlay-base {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 2600; /* 高于事件弹窗(2000) */
      display: none;
    }
    .overlay-base.active { display: block; }

    /* 暴雨动画效果 */
    .rain-overlay {
      /* 使用重复线性渐变模拟雨线，并做背景位移动画 */
      background-image: 
        repeating-linear-gradient(180deg,
          rgba(255,255,255,0) 0px,
          rgba(255,255,255,0) 6px,
          rgba(255,255,255,0.35) 6px,
          rgba(255,255,255,0.35) 8px
        );
      mix-blend-mode: overlay;
      filter: blur(0.3px);
      animation: rainFall 0.9s linear infinite;
      opacity: 0.8;
    }
    @keyframes rainFall {
      from { background-position-y: 0; }
      to { background-position-y: 100%; }
    }

    /* 国旗闪过动画 */
    .flag-overlay {
      display: none;
    }
    .flag-overlay.active {
      display: block;
    }
    .flag-overlay img {
      position: absolute;
      top: 12%;
      left: -240px;
      width: 200px;
      height: auto;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.25));
      animation: flagSlide 1.2s ease-out forwards;
      opacity: 0.95;
    }
    @keyframes flagSlide {
      0% { transform: translateX(0) rotate(-2deg); opacity: 0; }
      20% { opacity: 1; }
      80% { transform: translateX(calc(100vw + 240px)) rotate(2deg); opacity: 0.98; }
      100% { transform: translateX(calc(100vw + 240px)) rotate(2deg); opacity: 0; }
    }

    /* 盖章动画 */
    .stamp-overlay {
      display: none;
    }
    .stamp-overlay.active { display: block; }
    .stamp {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%) scale(0.1) rotate(-8deg);
      width: 240px; height: 240px;
      border: 8px solid #d7263d;
      border-radius: 50%;
      color: #d7263d;
      font-weight: 900;
      font-size: 32px;
      letter-spacing: 2px;
      text-align: center;
      line-height: 240px;
      background: rgba(215,38,61,0.06);
      box-shadow: 0 12px 24px rgba(215,38,61,0.25);
      animation: stampPop 0.6s cubic-bezier(.2,1.2,.3,1) forwards;
    }
    @keyframes stampPop {
      0% { transform: translate(-50%, -50%) scale(0.1) rotate(-12deg); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.08) rotate(-4deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1) rotate(-2deg); opacity: 1; }
    }

    /* 雪花动画（用于霜灾事件）*/
    .snow-overlay {
      display: none;
      pointer-events: none;
    }
    .snow-overlay.active { display: block; }
    /* 三层不同大小与速度的雪粒叠加（偏冷色、降低亮度） */
    .snow-overlay {
      background-image:
        radial-gradient(rgba(212, 228, 255, 0.45) 1px, transparent 1px),
        radial-gradient(rgba(212, 228, 255, 0.32) 1.5px, transparent 1.5px),
        radial-gradient(rgba(212, 228, 255, 0.28) 2px, transparent 2px);
      /* 加大间距以降低密度 */
      background-size: 14px 28px, 20px 40px, 32px 64px;
      background-position: 0 0, 0 0, 0 0;
      /* 放慢速度，避免视觉拥挤 */
      animation: snowFallA 10s linear infinite, snowFallB 16s linear infinite, snowFallC 22s linear infinite;
      mix-blend-mode: soft-light;
      opacity: 0.25;
      filter: blur(0.3px);
    }
    @keyframes snowFallA {
      from { background-position: 0 0; }
      to   { background-position: 0 100vh; }
    }
    @keyframes snowFallB {
      from { background-position: 0 0; }
      to   { background-position: 0 100vh; }
    }
    @keyframes snowFallC {
      from { background-position: 0 0; }
      to   { background-position: 0 100vh; }
    }

    /* 卡车动画 */
    .truck-overlay {
      display: none;
    }
    .truck-overlay.active { display: block; }
    .truck-overlay img {
      position: absolute;
      bottom: -150px; /* 从屏幕下方开始 */
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: auto;
      animation: truckDrive 2s ease-out forwards;
    }
    @keyframes truckDrive {
      0% { bottom: -150px; opacity: 0; }
      20% { opacity: 1; }
      80% { bottom: 50%; opacity: 1; }
      100% { bottom: 110%; opacity: 0; } /* 穿过屏幕 */
    }

    /* 图表动画 */
    .chart-overlay {
      display: none;
    }
    .chart-overlay.active { display: block; }
    .chart-overlay img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.5);
      width: 300px;
      height: auto;
      opacity: 0;
      animation: chartRise 1.5s ease-out forwards;
    }
    @keyframes chartRise {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* 工厂动画 */
    .factory-overlay {
      display: none;
    }
    .factory-overlay.active { display: block; }
    .factory-overlay img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      width: 400px;
      height: auto;
      opacity: 0;
      animation: factoryAppear 1.8s ease-out forwards;
    }
    @keyframes factoryAppear {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* 扩音器动画 */
    .megaphone-overlay {
      display: none;
    }
    .megaphone-overlay.active { display: block; }
    .megaphone-overlay img {
      position: absolute;
      top: 20%;
      right: -200px; /* 从屏幕右侧开始 */
      transform: rotate(15deg);
      width: 180px;
      height: auto;
      opacity: 0;
      animation: megaphoneAnnounce 1.6s ease-out forwards;
    }
    @keyframes megaphoneAnnounce {
      0% { right: -200px; opacity: 0; transform: rotate(15deg) scale(0.8); }
      30% { right: 50%; opacity: 1; transform: rotate(-5deg) scale(1.1); }
      70% { right: 50%; opacity: 1; transform: rotate(5deg) scale(1); }
      100% { right: 120%; opacity: 0; transform: rotate(15deg) scale(0.8); }
    }

    /* 灯泡动画 */
    .lightbulb-overlay {
      display: none;
    }
    .lightbulb-overlay.active { display: block; }
    .lightbulb-overlay img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.2);
      width: 150px;
      height: auto;
      opacity: 0;
      animation: lightbulbGlow 1.3s ease-out forwards;
    }
    @keyframes lightbulbGlow {
      0% { transform: translate(-50%, -50%) scale(0.2); opacity: 0; filter: brightness(0.5); }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; filter: brightness(1.5); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: brightness(1); }
    }

    /* 事件列表区样式 - 移除框架，直接融入event system */
.event-panel-content {
  flex: 1;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  min-height: 0;
  position: relative;
  padding: 0;
  gap: 8px;
  background: transparent;
  border-radius: 0;
  border: none;
  max-height: 450px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #ced4da #f8f9fa;
}

/* 事件项容器 - 包含Month框和事件内容 */
.event-item-container {
  width: 100%;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 12px;
}

.event-item-container:last-child {
  margin-bottom: 0;
}

/* 事件项中的Month框样式 */
.event-month-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #cdcdcd;
  border-radius: 16px;
  padding: 8px 6px;
  min-width: 50px;
  box-shadow: 0 2px 8px rgba(233, 236, 239, 0.3);
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.event-month-box:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(233, 236, 239, 0.4);
}

.event-month-label {
  font-size: 9px;
  font-weight: 600;
  color: rgba(108, 117, 125, 0.8);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-bottom: 2px;
}

.event-month-value {
  font-size: 16px;
  font-weight: 700;
  color: #6c757d;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  line-height: 1;
}

/* 事件历史项样式 */
.event-history-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  gap: 8px;
  padding: 16px 24px;
  background: #cdcdcd;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-sizing: border-box;
  border: none;
}

.event-history-item:last-child {
  margin-bottom: 0;
}

.event-history-item:hover {
  background: #c8cdd2;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* 事件项设计规范 */
.event-list-item {
  flex: 1;
  font-size: 14px;
  color: #495057;
  font-weight: 600;
  line-height: 1.4;
  text-align: left;
  cursor: pointer;
  transition: color 0.2s ease;
  margin: 0;
}

.event-list-item:hover {
  color: #343a40;
}

.event-list-effect {
  font-size: 12px;
  color: #6c757d;
  font-weight: 500;
  flex-shrink: 0;
  text-align: left;
  min-width: 80px;
  opacity: 0.9;
}

/* 时间线布局样式 */
.event-timeline {
  position: relative;
  padding-left: 20px;
}

.event-timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #e9ecef;
}

.event-timeline-item {
  position: relative;
  margin-bottom: 16px;
}

.event-timeline-item::before {
  content: '';
  position: absolute;
  left: -16px;
  top: 6px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #2f80ed;
  border: 2px solid #ffffff;
  box-shadow: 0 0 0 2px #2f80ed;
}

/* 滚动条样式 */
.event-panel-content::-webkit-scrollbar {
  width: 6px;
}

.event-panel-content::-webkit-scrollbar-track {
  background: #f8f9fa;
  border-radius: 8px;
}

.event-panel-content::-webkit-scrollbar-thumb {
  background: #ced4da;
  border-radius: 8px;
}

.event-panel-content::-webkit-scrollbar-thumb:hover {
      background: #adb5bd;
    }
    .event-panel-decoration {
      width: 80px;
      height: 80px;
      margin-top: 48px;
      opacity: 0.18;
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
      .event-panel {
        width: 98vw;
        min-height: 0;
        margin: 0 auto 20px auto;
      }
      
      .event-panel-header {
        padding: 16px 16px 14px 16px;
        min-height: 52px;
      }
      
      .event-panel-title {
        font-size: 1.1rem;
      }
      
      .event-panel-content {
        max-height: 240px;
      }
      
      .event-history-item {
        padding: 12px 16px;
      }
      
      .event-list-item {
        font-size: 13px;
      }
      
      .event-list-effect {
        font-size: 11px;
        min-width: 70px;
      }
      
      .module-image {
        width: 100px;
        height: 70px;
      }
      
      .module-building {
        height: 100px;
      }
      
      .module-title {
        font-size: 1rem;
      }
      
      .module-label {
        font-size: 0.9rem;
      }
      
      .module-value {
        font-size: 1.2rem;
      }
    }
    
    /* 交互反馈效果 */
    .event-history-item:active {
      transform: scale(0.98);
      transition: transform 0.1s ease;
    }
    
    .module-image:active {
      transform: scale(0.98);
      transition: transform 0.1s ease;
    }
    
    .panel-btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(47, 128, 237, 0.3) inset;
    }
    
    /* 触摸友好的交互区域 */
    .event-history-item {
      min-height: 48px;
    }
    
    .module-image {
      min-height: 60px;
    }
    
    /* 内容切换过渡效果 */
    .event-panel-content {
      transition: opacity 0.3s ease;
    }
    
    .event-panel-content.fade-in {
      opacity: 1;
    }
    
    .event-panel-content.fade-out {
      opacity: 0.5;
    }
    /* 新增装饰物样式 */
    .module-svg {
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%) translateY(18px);
      width: 100px;
      height: 68px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      pointer-events: none;
      z-index: 1;
    }
    .module-svg svg {
      width: 100px;
      height: 68px;
      display: block;
    }
    .ai-panel {
      width: 380px;
      min-height: 420px;
      background: #000000;
      border-radius: 18px;
      border: 1px solid #333333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 8px 24px rgba(0, 0, 0, 0.15), 0 16px 32px rgba(0, 0, 0, 0.1);
      font-family: 'Inria Serif', 'Arial', sans-serif;
      position: relative;
      margin: 0 0 0 -20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 0 0 16px 0;
      gap: 0;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .ai-panel:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25), 0 12px 32px rgba(0, 0, 0, 0.2), 0 24px 48px rgba(0, 0, 0, 0.15);
      border-color: #4d4d4d;
    }
    .ai-panel {
      background: #1e2a3a; /* Dark blue-gray background */
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* More modern font */
      color: #e0e6ed; /* Light text color */
      border: 1px solid rgba(70, 80, 90, 0.5); /* Subtle border */
      min-height: 400px; /* Fixed minimum height to enable flex layout */
    }
    .ai-game-title-row {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      background: linear-gradient(90deg, #2a3b4c 0%, #1e2a3a 100%); /* Subtle gradient */
      border-bottom: 1px solid rgba(70, 80, 90, 0.5);
    }
    .ai-game-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 0.8px;
    }
    .ai-game-chat-content {
      flex: 1;
      padding: 15px 20px;
      overflow-y: auto;
      min-height: 180px;
      max-height: 300px; /* Adjusted max-height */
      font-size: 0.95rem;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #1e2a3a; /* Match panel background */
    }
    .ai-game-msg-row {
      display: flex;
      align-items: flex-start; /* Align messages to top of row */
      margin-bottom: 10px;
    }
    .ai-game-msg-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: #fff;
      background: #4a5c70; /* Avatar background */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .ai-game-msg-avatar.ai {
      background: #5a708a; /* AI avatar color */
    }
    .ai-game-msg-avatar.user {
      background: #7a8fa8; /* User avatar color */
    }
    .ai-game-msg-bubble {
      max-width: 75%; /* Adjusted max-width for better readability */
      padding: 10px 15px;
      border-radius: 18px; /* More rounded corners */
      background: #2a3b4c; /* Message bubble background */
      color: #e0e6ed;
      font-size: 0.95em;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      word-break: break-word;
      line-height: 1.5;
      border: 1px solid rgba(70, 80, 90, 0.3);
    }
    .ai-game-msg-row.user {
      flex-direction: row-reverse;
    }
    .ai-game-msg-row.user .ai-game-msg-avatar {
      margin-left: 10px;
      margin-right: 0;
    }
    .ai-game-msg-row.user .ai-game-msg-bubble {
      background: #4a5c70; /* User message bubble background */
      color: #ffffff;
      border-radius: 18px;
    }
    .ai-game-input-row {
      display: flex;
      padding: 15px 20px;
      border-top: 1px solid rgba(70, 80, 90, 0.5);
      background: #1e2a3a;
      gap: 10px;
      align-items: center;
      margin-top: auto;
    }
    .ai-game-input {
      flex: 1;
      height: 42px;
      border-radius: 21px; /* Fully rounded input */
      border: 1px solid #4a5c70;
      font-size: 1rem;
      padding: 0 18px;
      background: #2a3b4c;
      color: #e0e6ed;
      transition: all 0.2s ease-in-out;
      font-family: inherit;
    }
    .ai-game-input::placeholder {
      color: #8a9bb0;
    }
    .ai-game-input:focus {
      outline: none;
      border-color: #6a809a;
      box-shadow: 0 0 0 3px rgba(106, 128, 154, 0.3);
      background: #2a3b4c;
    }
    .ai-game-send-btn {
      width: 42px;
      height: 42px;
      background: #5a708a; /* Send button color */
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .ai-game-send-btn:hover {
      background: #6a809a;
      transform: translateY(-1px);
    }
    .ai-game-send-btn:active {
      background: #4a5c70;
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }
    .ai-game-send-btn svg {
      display: block;
      fill: #ffffff; /* Ensure SVG icon is white */
    }
    /* Media queries adjustments */
    @media (max-width: 1100px) {
      .ai-panel {
        width: 380px;
        min-width: 380px;
      }
      .ai-game-chat-content, .ai-game-input-row {
        width: auto; /* Let flex handle width */
      }
      .ai-game-title {
        font-size: 1rem;
      }
    }
    @media (max-width: 900px) {
      .ai-panel {
        min-height: 200px; /* Slightly smaller on mobile */
      }
      .ai-game-title {
        font-size: 0.9rem;
      }
      .ai-game-chat-content {
        font-size: 0.9rem;
      }
      .ai-game-input {
        height: 38px;
        border-radius: 19px;
        font-size: 0.9rem;
      }
      .ai-game-send-btn {
        width: 38px;
        height: 38px;
      }
    }    
    /* 动画效果 */
    .number-animate, .cost-animate, .last-animate {
      animation: numberPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes numberPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: var(--radius-md);
    }

    ::-webkit-scrollbar-thumb {
      background: #4d4d4d;
      border-radius: var(--radius-md);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #666666;
    }

    /* 风险提示图标样式 */
    .risk-indicator {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .risk-icon {
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 4px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .risk-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .risk-icon.risk-low {
      color: #28a745;
      background: rgba(40, 167, 69, 0.1);
    }
    
    .risk-icon.risk-medium {
      color: #ffc107;
      background: rgba(255, 193, 7, 0.1);
    }
    
    .risk-icon.risk-high {
      color: #dc3545;
      background: rgba(220, 53, 69, 0.1);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .risk-tooltip {
  position: absolute;
  top: -40px;
  left: 0%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.65rem;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
    
    .risk-icon:hover + .risk-tooltip {
      opacity: 1;
      visibility: visible;
      top: -45px;
    }
    
    /* 响应式设计 */
    @media (max-width: 1200px) {
      .main-panel, .bottom-row-flex {
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-xl);
      }
      
      .module, .panel, .event-panel, .ai-panel {
        width: min(450px, 90vw);
      }
    }

    @media (max-width: 768px) {
      .search-container {
        width: 95vw;
        flex-direction: row;
        align-items: center;
      }
      
      .search-input {
        height: 50px;
        font-size: 1rem;
      }
      
      .month-bar {
        min-width: 50px;
        font-size: 1rem;
        padding: 6px 12px;
        color: #ffffff;
        background: #333333;
      }
      
      .module, .panel, .event-panel, .ai-panel {
        width: 95vw;
        min-height: 400px;
      }
      
      .main-panel, .bottom-row-flex {
        padding: 0 var(--spacing-sm);
        gap: var(--spacing-lg);
      }
    }
    
    /* 结算页面动画效果 */
    #summary-modal {

    }
    
    #summary-modal[style*="display: flex"] {
      opacity: 1;
      transform: scale(1);
      z-index: 9999 !important;
      z-index: 9999 !important;
    }
    
    .bottom-row-flex, .event-panel, .panel, .ai-panel {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      #summary-modal > div {
        padding: 20px 16px 12px 16px;
        min-width: 280px;
      }
      
      #echarts1, #echarts2 {
        width: 90vw !important;
        height: 200px !important;
      }
      
      #summary-modal .game-end-title {
        font-size: 1.4rem !important;
      }
      
      #summary-modal .game-end-summary {
        font-size: 0.95rem !important;
      }
    }
    
    @media (max-width: 480px) {
      #summary-modal > div {
        padding: 16px 12px 8px 12px;
      }
      
      #echarts1, #echarts2 {
        height: 180px !important;
      }
      
      #summary-modal .game-end-title {
        font-size: 1.2rem !important;
      }
      
      #summary-modal .game-end-summary {
        font-size: 0.85rem !important;
        text-align: center;
      }
    }
  </style>
</head>
<body>

  <!-- 回合计数器 -->
  <div class="round-counter-container">
    <div class="round-counter" id="round-counter">1/20 month</div>
  </div>

  <div class="main-panel">
    <div class="module factory-module">
      <img src="图库/factory-671598_1280.jpg" alt="Factory" class="factory-background-image" />
      <div class="factory-content">
        <div class="module-title" data-i18n="factory" style="margin-bottom: 2px;">Factory</div>
        <div style="font-size: 0.9rem; color: #f8f9fa; margin-bottom: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
          <span data-i18n="coffee_bean_price">Coffee Bean Price:</span> <span id="coffee-bean-price">0.50 unit</span>
        </div>
        <div class="module-label" data-i18n="shipment" style="margin-bottom: 2px;">Shipment</div>
        <div class="module-value" id="shipment-value" style="margin-bottom: 6px;">200<span class="unit-label">unit</span></div>
      </div>
    </div>
    <div class="module distributor-module">
      <img src="图库/store-5619201_1280.jpg" alt="Distributor" class="distributor-background-image" />
      <div class="distributor-content">
        <div class="module-title" data-i18n="distributor" style="margin-bottom: 4px;">Distributor</div>
        <div class="module-label" data-i18n="warehouse" style="margin-bottom: 2px;">Warehouse</div>
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 6px;">
          <div class="module-value" id="warehouse-value">400<span class="unit-label">unit</span></div>
          <div class="risk-indicator" id="risk-indicator" style="margin-left: 8px;">
            <div class="risk-icon" title="Delivery Risk Indicator">⚠️</div>
            <div class="risk-tooltip" id="risk-tooltip"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="module consumer-module">
      <img src="图库/center-2064919_1280.jpg" alt="Consumer" class="consumer-background-image" />
      <div class="consumer-content" style="padding: 8px 0 12px 0;">
        <div class="module-title" data-i18n="consumer" style="margin-bottom: 4px;">Consumer</div>
        <div class="module-label" data-i18n="demand" style="margin-bottom: 2px;">Demand</div>
        <div class="module-value" id="demand-value" style="margin-bottom: 6px;">200<span class="unit-label">unit</span></div>
        <div class="price-range-info" style="font-size: 0.9rem; color: #f8f9fa; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
          <div style="display: flex; align-items: center; margin-bottom: 2px;">
            <span data-i18n="price_range">Price Range:</span> 
            <div class="price-tooltip" style="margin-left: 5px; cursor: pointer; color: #f8f9fa; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);" onclick="showConsumerPriceRangeInfo()">?</div>
            <span id="consumer-price-range" style="margin-left: 5px;">0 - 2.0 unit</span>
          </div>
          <div><span data-i18n="acceptance">Acceptance:</span> <span id="consumer-acceptance">100%</span></div>
        </div>
      </div>
    </div>
  </div>
  <div class="bottom-row-flex">
    <div class="event-panel" id="event-panel">
      <!-- 顶部：标题栏 -->
      <div class="event-panel-header">
        <div class="event-panel-title">Incident System</div>
        
      </div>
      
      <!-- 中部：事件列表区 -->
      <div class="event-panel-content" id="event-panel-content">
        <!-- 事件列表将通过JavaScript动态生成 -->
      </div>
      
      
    </div>
    <div class="panel">
      <div class="panel-header">
        <h3 class="panel-title">Data</h3>
        <div class="panel-history-bar" style="margin-top: 0px; position: absolute; top: 16px; left: 16px;">
          <button class="history-btn" id="history-btn" title="View History">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0071e3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18M9 14h6"/></svg>
          </button>
          <span class="history-label">History</span>
        </div>
        <div class="panel-history-bar" style="margin-top: 0px; position: absolute; top: 16px; right: 16px;">
          <button class="history-btn" id="rules-btn" title="Rule">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0071e3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 17V5.5A2.5 2.5 0 0 1 9 3h9v14H9a2.5 2.5 0 0 0-2.5 2.5z"/></svg>
          </button>
          <span class="history-label">Rule</span>
        </div>
      </div>
      <div class="panel-content">

        
        <!-- 经济系统变量显示 -->
        <div class="economy-block" style="margin-top: 0px; padding: 10px; background: #ffdaa6; border-radius: 8px;">
          <div style="font-weight: bold; margin-bottom: 8px; color: #000000; font-size: 16px;" data-i18n="economic_system">Economic System</div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div style="font-size: 14px; color: #000000;" data-i18n="player_money">Player Money:</div>
            <div style="font-weight: bold; color: #28a745; font-size: 14px;" id="player-money-display">1000 unit</div>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <div style="font-size: 14px; color: #000000; display: flex; align-items: center;" data-i18n="player_income">Player Income:
                <div class="income-info-toggle" id="income-info-toggle" style="cursor: pointer; font-weight: bold; color: #f8f9fa; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-left: 5px;">?</div>
                <div class="income-details-popup" id="income-details-popup" style="display: none; position: absolute; background-color: rgba(0, 0, 0, 0.8); border: 1px solid #f8f9fa; padding: 10px; border-radius: 5px; z-index: 100; color: #f8f9fa; font-size: 0.8rem; text-align: left; min-width: 150px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
                    <div id="income-details-content"></div>
                </div>
              </div>
              <div style="font-weight: bold; color: #007bff; font-size: 14px;" id="player-income-display">0 unit</div>
            </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <div style="font-size: 14px; color: #000000; display: flex; align-items: center;" data-i18n="cost">Cost:
                <div class="cost-info-toggle" id="cost-info-toggle" style="cursor: pointer; font-weight: bold; color: #f8f9fa; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-left: 5px;">?</div>
                <div class="cost-details-popup" id="cost-details-popup" style="display: none; position: absolute; background-color: rgba(0, 0, 0, 0.8); border: 1px solid #f8f9fa; padding: 10px; border-radius: 5px; z-index: 100; color: #f8f9fa; font-size: 0.8rem; text-align: left; min-width: 150px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
                    <div id="cost-details-content"></div>
                </div>
              </div>
              <div style="font-weight: bold; color: #dc3545; font-size: 14px;" id="cost-value">0</div>
            </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center;">
              <div style="font-size: 14px; color: #000000;" data-i18n="plantation_price">Plantation Price:</div>
              <div class="price-tooltip" style="margin-left: 5px; cursor: pointer; color: #007bff; font-weight: bold;" onclick="showPlantationPriceLogic()">?</div>
            </div>
            <div style="font-weight: bold; color: #dc3545; font-size: 14px;" id="plantation-price-display">0.1 unit</div>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div style="font-size: 14px; color: #000000;" data-i18n="player_price">Player Price:</div>
            <div style="font-weight: bold; color: #6f42c1; font-size: 14px;" id="player-price-display">1.0 unit</div>
          </div>
        </div>



        <div class="panel-row" style="margin-top: 10px;">
          <div class="panel-label">Orders to Plantation</div>
          <input class="panel-input" id="input1" type="number" min="0" value="0">
        </div>
        <div class="panel-row">
          <div class="panel-label">Shipments to Consumers</div>
          <input class="panel-input" id="input2" type="number" min="0" value="0">
        </div>
        <div class="panel-row">
          <div class="panel-label" data-i18n="player_selling_price">Player Selling Price</div>
          <input class="panel-input" id="player-price-input" type="number" min="0.1" step="0.01" value="1.0">
        </div>
        <button class="panel-btn" id="confirm-btn">Confirm</button>
      </div>
    </div>
    <div class="ai-panel" id="ai-panel">
      <div class="ai-game-title-row">
        <span class="ai-game-title">Intelligent Advisor</span>
      </div>
      <div class="ai-game-chat-content" id="ai-chat-content"></div>
      
      
      
      
      <div class="ai-game-input-row">
        <input class="ai-game-input" id="ai-input" type="text" placeholder="输入您的问题..." />
        <button class="ai-game-send-btn" id="ai-send-btn" title="发送">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="#2c2c2c"/><path d="M7 17L17 12L7 7V11L13 12L7 13V17Z" fill="#fff"/></svg>
        </button>
      </div>
    </div>
  </div>
  <!-- 历史弹窗 -->
  <div class="history-modal" id="history-modal" style="display:none;">
    <div class="history-mask" id="history-mask"></div>
    <div class="history-content">
      <div class="history-header">
        <span>History</span>
        <button class="history-close" id="history-close">×</button>
      </div>
      <div class="history-table-wrap">
        <table class="history-table" id="history-table">
          <thead><tr><th>Round</th><th>Orders</th><th>Shipments</th><th>Income</th><th>Cost</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- 事件系统浮窗 -->
  <div id="event-modal-mask" class="event-modal-mask" style="display:none;">
    <div class="event-modal">
      <button class="event-modal-close" id="event-modal-close">×</button>
      <div class="event-modal-title" id="event-modal-title"></div>
      <div class="event-modal-desc" id="event-modal-desc"></div>
      <div class="event-modal-effect" id="event-modal-effect"></div>
    </div>
  </div>
  <!-- 游戏总结图表弹窗 -->
  <div id="summary-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; z-index:3000; background:rgba(0,0,0,0.12); align-items:center; justify-content:center;">
    <div style="background:#ffffff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.12); padding:28px 24px 18px 24px; min-width:340px; max-width:96vw; max-height:90vh; overflow:auto; position:relative; display:flex; flex-direction:column; align-items:center; border:1px solid #e9ecef;">
      <button id="summary-close" style="position:absolute; top:12px; right:16px; background:#f8f9fa; border:1px solid #e9ecef; font-size:1.4rem; color:#6c757d; cursor:pointer; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; transition:all 0.2s ease;">×</button>
      <!-- 庆祝动画和提示 -->
      <div style="width:100%; display:flex; flex-direction:column; align-items:center; margin-bottom:10px;">
        <svg width="120" height="40" viewBox="0 0 120 40" style="margin-bottom:4px;"><g><path d="M10 30 Q30 10 60 30 T110 30" stroke="#2f80ed" stroke-width="4" fill="none"/><circle cx="30" cy="15" r="4" fill="#b71c1c"><animate attributeName="cy" values="15;8;15" dur="1.2s" repeatCount="indefinite"/></circle><circle cx="60" cy="30" r="4" fill="#f7d900"><animate attributeName="cy" values="30;22;30" dur="1.1s" repeatCount="indefinite"/></circle><circle cx="90" cy="20" r="4" fill="#2f80ed"><animate attributeName="cy" values="20;12;20" dur="1.3s" repeatCount="indefinite"/></circle></g></svg>
        <div style="font-size:1.6rem; font-weight:800; color:#2f80ed; letter-spacing:2px;" data-i18n="game_end_title">Game Over</div>
        <div style="font-size:1.08rem; color:#28a745; margin-top:6px; margin-bottom:8px;" data-i18n="game_end_summary">Congratulations on completing the game! Here is your round summary:</div>
        <div style="width:100%; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:10px;">
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Total Revenue</div>
            <div id="kpi-revenue" style="font-size:20px; font-weight:800; color:#2f80ed;">0</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Total Cost</div>
            <div id="kpi-cost" style="font-size:20px; font-weight:800; color:#b71c1c;">0</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Total Profit</div>
            <div id="kpi-profit" style="font-size:20px; font-weight:800; color:#28a745;">0</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Avg Price</div>
            <div id="kpi-avg-price" style="font-size:20px; font-weight:800; color:#343a40;">0</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Avg Acceptance</div>
            <div id="kpi-avg-accept" style="font-size:20px; font-weight:800; color:#343a40;">0%</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Total Shipments</div>
            <div id="kpi-shipments" style="font-size:20px; font-weight:800; color:#343a40;">0</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Peak Demand</div>
            <div id="kpi-peak-demand" style="font-size:20px; font-weight:800; color:#343a40;">0</div>
          </div>
          <div style="flex:1 1 160px; max-width:240px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center;">
            <div style="font-size:12px; color:#6c757d;">Final Warehouse</div>
            <div id="kpi-final-warehouse" style="font-size:20px; font-weight:800; color:#343a40;">0</div>
          </div>
        </div>
      </div>
      <div id="echarts1" style="width:520px; max-width:90vw; height:280px; margin-bottom:32px;"></div>
      <div id="echarts2" style="width:520px; max-width:90vw; height:220px;"></div>
      <div id="echarts3" style="width:520px; max-width:90vw; height:260px; margin-top:12px;"></div>
      <div id="echarts4" style="width:520px; max-width:90vw; height:240px; margin-top:12px;"></div>
    </div>
  </div>

  <!-- 动画覆盖层：暴雨 -->
  <div id="rain-overlay" class="overlay-base rain-overlay"></div>
  <!-- 动画覆盖层：雪花（霜灾） -->
  <div id="snow-overlay" class="overlay-base snow-overlay"></div>
  <!-- 动画覆盖层：国旗闪过 -->
  <div id="flag-overlay" class="overlay-base flag-overlay">
    <img src="./图库/flag-7878870_1280.jpg" alt="Flag" />
  </div>
  <!-- 动画覆盖层：盖章 -->
  <div id="stamp-overlay" class="overlay-base stamp-overlay">
    <div class="stamp">政策变动</div>
  </div>
  <!-- 动画覆盖层：卡车 -->
  <div id="truck-overlay" class="overlay-base truck-overlay">
    <img src="./图库/delivery.png" alt="Truck" />
  </div>
  <!-- 动画覆盖层：图表 -->
  <div id="chart-overlay" class="overlay-base chart-overlay">
    <img src="./图库/chart-671.png" alt="Chart" />
  </div>
  <!-- 动画覆盖层：工厂 -->
  <div id="factory-overlay" class="overlay-base factory-overlay">
    <img src="./图库/factory-icon-1238.png" alt="Factory" />
  </div>
  <!-- 动画覆盖层：扩音器 -->
  <div id="megaphone-overlay" class="overlay-base megaphone-overlay">
    <img src="./图库/megaphone-icon-308.png" alt="Megaphone" />
  </div>
  <!-- 动画覆盖层：灯泡 -->
  <div id="lightbulb-overlay" class="overlay-base lightbulb-overlay">
    <img src="./图库/placeholder_lightbulb.png" alt="Lightbulb" />
  </div>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
   
   <script>
    // 多语言支持系统
    const translations = {
      'en': {
        // 页面标题
        'page_title': 'Coffee Supply Chain Simulation Game',
        
        // 模块标题
        'factory': 'Factory',
        'shipment': 'Shipment',
        'distributor': 'Distributor',
        'warehouse': 'Warehouse',
        'consumer': 'Consumer',
        'demand': 'Demand',
        
        // 单位标签
        'unit_bags': 'bags',
        
        // 面板标题
        'incident_system': 'Incident System',
        'current_event_status': 'Current Event Status',
        'data_dashboard': 'Data Dashboard',
        'history': 'History',
        'cost': 'Cost',
        
        // 数据标签
        'factories_order': 'Factories Order',
        'consumer_order': 'Consumer Order',
        'planned_receipt': 'Planned Receipt',
        'actual_receipt': 'Actual Receipt',
        'planned_arrival': 'Planned Arrival',
        'actual_arrival': 'Actual Arrival',
        'orders_to_plantation': 'Orders to Plantation',
        'shipments_to_consumers': 'Shipments to Consumers',
        'player_selling_price': 'Player Selling Price',
        
        // 按钮
        'confirm': 'Confirm',
        'game_over': 'Game Over',
        
        // 历史记录
        'round': 'Round',
        'orders': 'Orders',
        'shipments': 'Shipments',
        
        // AI面板
        'ai_assistant': 'ChatGPT',
        'enter_question': 'Enter your question...',
        
        // 事件系统
        'no_events': 'No Events',
        'event_records': 'Event records will be displayed during gameplay',
        
        // 游戏结束
        'game_end_title': 'Game Over',
        'game_end_summary': 'Congratulations on completing the game! Here is your round summary:',
        'warehouse_shipment_demand': 'Warehouse/Shipment/Demand',
        'cost_per_round': 'Cost per Round',
        
        // 月份
        'month': 'Month',
        
        // 错误信息
        'request_failed': 'Request failed, please try again later.',
        
        // 经济系统
        'economic_system': 'Economic System',
        'player_money': 'Player Money',
        'player_income': 'Player Income',
        'plantation_price': 'Plantation Price',
        'player_price': 'Player Price',
        
        // 价格区间和接受度
        'price_range': 'Price Range',
        'acceptance': 'Acceptance'
      },
      'zh': {
        // 页面标题
        'page_title': '咖啡供应链模拟游戏',
        
        // 模块标题
        'factory': '工厂',
        'shipment': '发货量',
        'distributor': '分销商',
        'warehouse': '仓库',
        'consumer': '消费者',
        'demand': '需求量',
        
        // 单位标签
        'unit_bags': '袋',
        
        // 面板标题
        'incident_system': '事件系统',
        'current_event_status': '当前事件状态',
        'data_dashboard': '数据面板',
        'history': '历史记录',
        'cost': '成本',
        
        // 数据标签
        'factories_order': '工厂订单',
        'consumer_order': '消费者订单',
        'planned_receipt': '计划收货',
        'actual_receipt': '实际收货',
        'planned_arrival': '计划到达',
        'actual_arrival': '实际到达',
        'orders_to_plantation': '向种植园订购',
        'shipments_to_consumers': '向消费者发货',
        'player_selling_price': '玩家销售价格',
        
        // 按钮
        'confirm': '确认',
        'game_over': '游戏结束',
        
        // 历史记录
        'round': '回合',
        'orders': '订单',
        'shipments': '发货',
        
        // AI面板
        'ai_assistant': '智能助手',
        'enter_question': '输入您的问题...',
        
        // 事件系统
        'no_events': '暂无事件',
        'event_records': '游戏过程中将显示事件记录',
        
        // 游戏结束
        'game_end_title': '游戏结束',
        'game_end_summary': '恭喜你完成本局游戏！以下是你的回合总结：',
        'warehouse_shipment_demand': '仓库库存量/发货量/需求量',
        'cost_per_round': '每回合成本',
        
        // 月份
        'month': '月份',
        
        // 错误信息
        'request_failed': '请求失败，请稍后再试。',
        
        // 经济系统
        'economic_system': '经济系统',
        'player_money': '玩家资金',
        'player_income': '玩家收入',
        'plantation_price': '种植园价格',
        'player_price': '玩家销售价格',
        
        // 价格区间和接受度
        'price_range': '价格区间',
        'acceptance': '接受度'
      }
    };
    
    // 当前语言
    let currentLang = 'en';
    
    // 获取翻译文本
    function t(key) {
      return translations[currentLang][key] || key;
    }
    
    // 切换语言函数
    function switchLanguage(lang) {
      if (lang === currentLang) return;
      currentLang = lang;
      
      // 更新按钮状态
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
      });
      
      // 更新页面标题
      document.title = t('page_title');
      
      // 更新所有带有 data-i18n 属性的元素
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (el.tagName === 'INPUT' && el.getAttribute('type') === 'text') {
          el.placeholder = t(key);
        } else {
          el.textContent = t(key);
        }
      });
      
      // 更新特定元素
      updateSpecificElements();
      
      // 重新渲染事件面板
      renderEventPanel();
      
      // 重新渲染历史表格
      renderHistoryTable();
      
      // 更新图表标题
      updateChartTitles();
    }
    
    // 更新特定元素
    function updateSpecificElements() {
      // 确认按钮
      if (confirmBtn) {
        if (round > maxRound) {
          confirmBtn.textContent = t('game_over');
        } else {
          confirmBtn.textContent = t('confirm');
        }
      }
      
      // 月份栏
      if (monthBarText) {
        monthBarText.textContent = `${t('month')} ${round}`;
      }
      
      // AI输入框占位符
      if (aiInput) {
        aiInput.placeholder = t('enter_question');
      }
    }
    
    // 更新图表标题
    function updateChartTitles() {
      const charts = echarts.getInstanceByDom(document.getElementById('echarts1'));
      if (charts) {
        const option = charts.getOption();
        option.title[0].text = t('warehouse_shipment_demand');
        option.legend[0].data = [t('warehouse'), t('shipment'), t('demand')];
        option.xAxis[0].name = t('round');
        option.yAxis[0].name = t('unit_bags');
        charts.setOption(option);
      }
      
      const charts2 = echarts.getInstanceByDom(document.getElementById('echarts2'));
      if (charts2) {
        const option = charts2.getOption();
        option.title[0].text = t('cost_per_round');
        option.legend[0].data = [t('cost')];
        option.xAxis[0].name = t('round');
        option.yAxis[0].name = t('cost');
        charts2.setOption(option);
      }
    }
    
    // 语言切换按钮点击事件
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        switchLanguage(lang);
      });
    });
    

   </script>
   
   <script>
    // 初始值
    let shipment = 200; // 发货量
    let warehouse = 400; // 仓库
    let demand = 200; // 需求量
    let prevShipment = 200; // 上一回合发货量
    let prevDemand = 200; // 上一回合需求量
    let round = 1;
    let cost = 0; // 成本
    let currentBaseCost = 0; // 基础成本
    let currentExcessInventoryCost = 0; // 超额库存成本
    let currentPurchaseCost = 0; // 采购成本

    const maxRound = 20;
    let historyArr = [];
    
    // 经济系统变量
    let playerMoney = 1000; // 玩家初始资金 1000 unit
    let playerIncome = 0; // 玩家收入（动态计算）
    let profitMarginPerUnit = 0; // 每单位利润
    let actualShipmentQuantity = 0; // 实际发货量
    let effectiveAcceptanceRate = 0; // 有效接受率
    let plantationPrice = 0.5; // 种植园销售价格（初始值，基于需求量动态调整 0.1-1.55 unit）
      let prevPlantationPrice = 0.5; // 上一回合的种植园销售价格
      let playerSellingPrice = 1.0; // 玩家销售价格（自由定价）
    
    // 需求动态调整系统变量
    let unsatisfiedDemand = 0; // 未满足的需求（用于需求惩罚）
    let consecutiveUnsatisfiedRounds = 0; // 连续未满足需求的回合数（用于垄断惩罚）
    let demandHistory = []; // 需求历史记录（用于垄断惩罚判断）
    let prevRoundShipmentForWarehouse = 200; // 存储上一回合的发货量，作为本回合的入库量
    
    // 风险计算系统变量
    let deliveryRisk = 45; // 到货延迟风险百分比 (0-100)
let receiptRisk = 30; // 收货延迟风险百分比 (0-100)

    const shipmentValue = document.getElementById('shipment-value');
    const warehouseValue = document.getElementById('warehouse-value');
    const demandValue = document.getElementById('demand-value');
    const input1 = document.getElementById('input1');
    const input2 = document.getElementById('input2');
    const confirmBtn = document.getElementById('confirm-btn');
    const monthBar = document.getElementById('month-bar');
    const costValue = document.getElementById('cost-value');
    const costInfoToggle = document.getElementById('cost-info-toggle');
    const costDetailsPopup = document.getElementById('cost-details-popup');
    const incomeInfoToggle = document.getElementById('income-info-toggle');
    const incomeDetailsPopup = document.getElementById('income-details-popup');

    costInfoToggle.addEventListener('click', () => {
      if (costDetailsPopup.style.display === 'none') {
        costDetailsPopup.style.display = 'block';
      } else {
        costDetailsPopup.style.display = 'none';
      }
    });

    incomeInfoToggle.addEventListener('click', () => {
      if (incomeDetailsPopup.style.display === 'none') {
        incomeDetailsPopup.style.display = 'block';
      } else {
        incomeDetailsPopup.style.display = 'none';
      }
    });

    document.addEventListener('click', (event) => {
      if (!costInfoToggle.contains(event.target) && !costDetailsPopup.contains(event.target)) {
        costDetailsPopup.style.display = 'none';
      }
      if (!incomeInfoToggle.contains(event.target) && !incomeDetailsPopup.contains(event.target)) {
        incomeDetailsPopup.style.display = 'none';
      }
    });


    function updateDisplay() {
      animateNumber(shipmentValue, shipment);
      animateNumber(warehouseValue, warehouse);
      animateNumber(demandValue, demand);
      animateNumber(costValue, '$' + cost.toFixed(1).replace(/\.0$/, ''));

      
      // 更新经济系统变量显示
      document.getElementById('player-money-display').textContent = playerMoney.toFixed(0) + ' unit';
      document.getElementById('player-income-display').textContent = playerIncome.toFixed(0) + ' unit';
      document.getElementById('plantation-price-display').textContent = plantationPrice.toFixed(2) + ' unit';
      document.getElementById('coffee-bean-price').textContent = plantationPrice.toFixed(2) + ' unit';
      document.getElementById('player-price-display').textContent = playerSellingPrice.toFixed(2) + ' unit';
      
      // 更新风险提示显示
      updateRiskIndicator();
      
      // 更新回合计数器显示
      updateRoundCounter();
      updateCostDetails();
      updateIncomeDetails();
    }

    function updateCostDetails() {
      const costDetailsContent = document.getElementById('cost-details-content');
      if (costDetailsContent) {
        costDetailsContent.innerHTML = `
          <div>Base Cost: ${currentBaseCost.toFixed(1)} unit</div>
          <div>Excess Inventory Cost: ${currentExcessInventoryCost.toFixed(1)} unit</div>
          <div>Purchase Cost: ${currentPurchaseCost.toFixed(1)} unit</div>
        `;
      }
    }

    function updateIncomeDetails() {
      const incomeDetailsContent = document.getElementById('income-details-content');
      if (incomeDetailsContent) {
        incomeDetailsContent.innerHTML = `
          <p><strong>Income Details:</strong></p>
          <p>Player Selling Price: ${playerSellingPrice.toFixed(2)}</p>
          <p>Actual Shipment: ${actualShipmentQuantity}</p>
          <p>Effective Acceptance Rate: ${effectiveAcceptanceRate.toFixed(2)}%</p>
        `;
      }
    }
    
    
    // 更新回合计数器显示
    function updateRoundCounter() {
      const roundCounter = document.getElementById('round-counter');
      if (roundCounter) {
        if (round > maxRound) {
          roundCounter.textContent = 'Game Over';
        } else {
          roundCounter.textContent = `${round}/${maxRound} month`;
        }
      }
    }
    
    // 动态更新风险值
    function updateRiskValues() {
      // 基于游戏状态动态计算风险值
      
      // 1. 到货风险（deliveryRisk）基于库存和订单的匹配度
      // 如果库存远低于需求，到货风险增加
      const inventoryRisk = warehouse < demand ? Math.min(100, Math.round((demand - warehouse) / demand * 100)) : 0;
      
      // 2. 收货风险（receiptRisk）基于发货量和需求的匹配度
      // 如果发货量远低于需求，收货风险增加
      const shipmentRisk = shipment < demand ? Math.min(100, Math.round((demand - shipment) / demand * 100)) : 0;
      
      // 3. 回合进度影响：随着回合进行，风险逐渐增加
      const roundRisk = Math.min(100, Math.round((round / maxRound) * 50));
      
      // 4. 成本压力影响：成本越高，风险越大
      const costRisk = Math.min(100, Math.round(cost / 1000 * 30));
      
      // 5. 需求波动影响：需求波动越大，风险越高
      let demandVolatility = 0;
      if (demandHistory.length >= 2) {
        const recentDemands = demandHistory.slice(-3); // 最近3回合
        const avgDemand = recentDemands.reduce((a, b) => a + b, 0) / recentDemands.length;
        const variance = recentDemands.reduce((a, b) => a + Math.pow(b - avgDemand, 2), 0) / recentDemands.length;
        demandVolatility = Math.min(100, Math.round(Math.sqrt(variance) / avgDemand * 100));
      }
      
      // 综合计算最终风险值
      deliveryRisk = Math.min(100, Math.round(
        inventoryRisk * 0.4 + 
        roundRisk * 0.3 + 
        costRisk * 0.2 + 
        demandVolatility * 0.1
      ));
      
      receiptRisk = Math.min(100, Math.round(
        shipmentRisk * 0.5 + 
        roundRisk * 0.3 + 
        costRisk * 0.2
      ));
      
      // 确保风险值不会为0（除非游戏刚开始）
      if (round > 1) {
        deliveryRisk = Math.max(5, deliveryRisk);
        receiptRisk = Math.max(5, receiptRisk);
      }
    }

    // 更新风险提示图标显示
    function updateRiskIndicator() {
      const riskIndicator = document.getElementById('risk-indicator');
      const riskTooltip = document.getElementById('risk-tooltip');
      
      // 计算总风险（到货风险和收货风险的加权平均）
      const totalRisk = Math.max(deliveryRisk, receiptRisk);
      
      if (totalRisk > 0) {
        riskIndicator.style.display = 'flex';
        
        // 根据风险级别设置不同的提示信息（英文）
        let riskMessage = '';
        let riskLevel = '';
        
        if (totalRisk > 60) {
          riskMessage = `High Risk: ${totalRisk}% delay, immediate attention`;
          riskLevel = 'high';
        } else if (totalRisk >= 31) {
          riskMessage = `Medium Risk: ${totalRisk}% delay, needs attention`;
          riskLevel = 'medium';
        } else {
          riskMessage = `Low Risk: ${totalRisk}% delay, smooth operation`;
          riskLevel = 'low';
        }
        
        riskTooltip.textContent = riskMessage;
        riskIndicator.className = `risk-indicator risk-${riskLevel}`;
      } else {
        riskIndicator.style.display = 'none';
      }
    }

    // 保证unit标签在数字变动时不被重置
    function animateNumber(element, value) {
      if (element.id === 'shipment-value' || element.id === 'warehouse-value' || element.id === 'demand-value') {
        // 只更新数字部分
        const unit = element.querySelector('.unit-label');
        if (element.childNodes[0].textContent != value) {
          element.childNodes[0].textContent = value;
          element.classList.remove('number-animate');
          void element.offsetWidth;
          element.classList.add('number-animate');
        }
        return;
      }
      if (false) {
         // 对于last-order-value和last-shipment-value，保留"(Last Month)"文本
         // 检查数值是否需要更新
         const currentValue = element.childNodes[0]?.nodeValue?.trim() || element.textContent.split(" ")[0];
         if (currentValue != value) {
           // 清空元素内容
           while (element.firstChild) {
             element.removeChild(element.firstChild);
           }
           // 添加新的数值
           element.textContent = value;
           // 添加灰色的(Last Month)文本
           const lastMonthSpan = document.createElement('span');
           lastMonthSpan.textContent = " (Last Month)";
           lastMonthSpan.style.color = "gray";
           element.appendChild(lastMonthSpan);
           // 添加动画效果
           element.classList.remove('number-animate');
           element.classList.remove('cost-animate');
           element.classList.remove('last-animate');
           void element.offsetWidth;
           element.classList.add('last-animate');
         }
      } else if (element.textContent != value) {
        element.textContent = value;
        element.classList.remove('number-animate');
        element.classList.remove('cost-animate');
        element.classList.remove('last-animate');
        void element.offsetWidth;
        if (element === costValue) {
          element.classList.add('cost-animate');
        } else {
          element.classList.add('number-animate');
        }
      } else {
        element.textContent = value;
      }
    }

    function renderHistoryTable() {
      const tbody = document.querySelector('#history-table tbody');
      tbody.innerHTML = '';
      historyArr.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${item.order}</td><td>${item.shipment}</td><td>${item.income.toFixed(2)}</td><td>${item.cost.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // 历史弹窗交互
    document.getElementById('history-btn').onclick = function() {
      renderHistoryTable();
      document.getElementById('history-modal').style.display = 'flex';
    };
    document.getElementById('history-close').onclick = function() {
      document.getElementById('history-modal').style.display = 'none';
    };
    document.getElementById('history-mask').onclick = function() {
      document.getElementById('history-modal').style.display = 'none';
    };

    // 事件系统
    const events = [
      {
        title: 'Port Strikes and Logistics Disruptions',
        desc: 'Major global shipping ports experience large-scale strikes due to labor disputes, leading to numerous cargo ships being stranded and international logistics networks paralyzed.',
        effect: 'Warehouse capacity cannot be replenished during the event (two rounds). Delayed orders caused by this event will be stored in the warehouse at the end of the event round.',
        type: 'logistics_disruption',
        animation: 'truck'
      },
      {
        title: 'Soaring Prices of Key Raw Materials',
        desc: 'Due to extreme weather events, coffee bean production areas experience a sharp decline in yield, causing prices to double in a short period.',
        effect: 'Coffee bean procurement cost increases by 50% for 3 game rounds.',
        type: 'market_fluctuation',
        animation: 'chart'
      },
      {
        title: 'Competitor Launches Disruptive Technology',
        desc: 'Your main competitor successfully develops and implements a new production technology, reducing their product costs by 20%.',
        effect: 'Consumer demand decreases by 25% (lasts for two rounds).',
        type: 'competition',
        animation: 'factory'
      },
      {
        title: 'Government Introduces New Trade Protection Policies',
        desc: 'The government of your main exporting or importing country suddenly imposes high tariffs on your products to protect its domestic industries.',
        effect: 'Coffee bean procurement price increases by 100% (lasts for two game rounds).',
        type: 'policy_change',
        animation: 'flag'
      },
      {
        title: 'Negative Public Opinion on Social Media',
        desc: 'A consumer posts a negative review about your product\'s quality issues on social media, quickly leading to widespread shares and discussions.',
        effect: 'Demand decreases by 30% (lasts for two rounds).',
        type: 'public_relations',
        animation: 'megaphone'
      },
      {
        title: 'Emerging Market Opportunity',
        desc: 'A market research report indicates that an emerging economy\'s population structure and consumption capacity are rapidly growing, showing strong potential demand for your products.',
        effect: 'Demand increases by 50% (lasts for 2 rounds)',
        type: 'market_opportunity',
        animation: 'lightbulb'
      }
    ];

    let appearedEvents = []; // 存储已出现事件的索引
    let eventIndex = -1;
    let lastEventIndex = -1;
    const eventPanelContent = document.getElementById('event-panel-content');
    const eventModalMask = document.getElementById('event-modal-mask');
    const eventModalTitle = document.getElementById('event-modal-title');
    const eventModalDesc = document.getElementById('event-modal-desc');
    const eventModalEffect = document.getElementById('event-modal-effect');
    const eventModalClose = document.getElementById('event-modal-close');

    // 显示事件浮窗
    function showEventModal(idx, customTitle, customDesc, customButtonText) {
      if (customTitle && customDesc) {
        eventModalTitle.textContent = customTitle;
        eventModalDesc.textContent = customDesc;
        eventModalEffect.textContent = customButtonText || '确定'; // 默认按钮文本为“确定”
        eventModalMask.style.display = 'flex';
      } else if (events[idx]) {
        eventModalTitle.textContent = events[idx].title;
        eventModalDesc.textContent = events[idx].desc;
        eventModalEffect.textContent = events[idx].effect;
        eventModalMask.style.display = 'flex';

        // 根据事件类型触发动画
        const evt = events[idx];
        if (evt.animation === 'snow') {
          playSnow(2200);
        } else if (evt.animation === 'rainstorm') {
          playRainstorm(2200);
        } else if (evt.animation === 'flag') {
          playPolicyFlag(1400);
        } else if (evt.animation === 'stamp') {
          playPolicyStamp(1000);
        } else if (evt.animation === 'truck') {
          playTruck(2000);
        } else if (evt.animation === 'chart') {
          playChart(2000);
        } else if (evt.animation === 'factory') {
          playFactory(2000);
        } else if (evt.animation === 'megaphone') {
          playMegaphone(2000);
        } else if (evt.animation === 'lightbulb') {
          playLightbulb(2000);
        }
      }
    }
    // 关闭事件浮窗时，立即取消动画并刷新历史
    eventModalClose.onclick = function() {
      stopAllAnimations();
      eventModalMask.style.display = 'none';
      renderEventPanel();
    };
    eventModalMask.onclick = function(e) {
      if (e.target === eventModalMask) eventModalClose.onclick();
    };

    // ---- 动画控制逻辑 ----
    const rainOverlay = document.getElementById('rain-overlay');
    const flagOverlay = document.getElementById('flag-overlay');
    const snowOverlay = document.getElementById('snow-overlay');
    const stampOverlay = document.getElementById('stamp-overlay');

    function playRainstorm(duration = 2000) {
      rainOverlay.classList.add('active');
      clearTimeout(playRainstorm._timer);
      playRainstorm._timer = setTimeout(() => {
        rainOverlay.classList.remove('active');
      }, duration);
    }

    function playPolicyFlag(duration = 1200) {
      flagOverlay.classList.add('active');
      // 每次触发都强制重启动画
      const img = flagOverlay.querySelector('img');
      img.style.animation = 'none';
      // 强制重排：
      void img.offsetWidth;
      img.style.animation = 'flagSlide 1.2s ease-out forwards';
      clearTimeout(playPolicyFlag._timer);
      playPolicyFlag._timer = setTimeout(() => {
        flagOverlay.classList.remove('active');
      }, duration);
    }

    function playPolicyStamp(duration = 1000) {
      stampOverlay.classList.add('active');
      const stamp = stampOverlay.querySelector('.stamp');
      stamp.style.animation = 'none';
      void stamp.offsetWidth;
      stamp.style.animation = 'stampPop 0.6s cubic-bezier(.2,1.2,.3,1) forwards';
      clearTimeout(playPolicyStamp._timer);
      playPolicyStamp._timer = setTimeout(() => {
        stampOverlay.classList.remove('active');
      }, duration);
    }

    function playSnow(duration = 2000) {
      snowOverlay.classList.add('active');
      clearTimeout(playSnow._timer);
      playSnow._timer = setTimeout(() => {
        snowOverlay.classList.remove('active');
      }, duration);
    }

    const truckOverlay = document.getElementById('truck-overlay');
    const chartOverlay = document.getElementById('chart-overlay');
    const factoryOverlay = document.getElementById('factory-overlay');
    const megaphoneOverlay = document.getElementById('megaphone-overlay');
    const lightbulbOverlay = document.getElementById('lightbulb-overlay');

    function playTruck(duration = 2000) {
      truckOverlay.classList.add('active');
      const img = truckOverlay.querySelector('img');
      img.style.animation = 'none';
      void img.offsetWidth;
      img.style.animation = 'truckDrive 2s ease-out forwards';
      clearTimeout(playTruck._timer);
      playTruck._timer = setTimeout(() => {
        truckOverlay.classList.remove('active');
      }, duration);
    }

    function playChart(duration = 2000) {
      chartOverlay.classList.add('active');
      const img = chartOverlay.querySelector('img');
      img.style.animation = 'none';
      void img.offsetWidth;
      img.style.animation = 'chartRise 1.5s ease-out forwards';
      clearTimeout(playChart._timer);
      playChart._timer = setTimeout(() => {
        chartOverlay.classList.remove('active');
      }, duration);
    }

    function playFactory(duration = 2000) {
      factoryOverlay.classList.add('active');
      const img = factoryOverlay.querySelector('img');
      img.style.animation = 'none';
      void img.offsetWidth;
      img.style.animation = 'factoryAppear 1.8s ease-out forwards';
      clearTimeout(playFactory._timer);
      playFactory._timer = setTimeout(() => {
        factoryOverlay.classList.remove('active');
      }, duration);
    }

    function playMegaphone(duration = 2000) {
      megaphoneOverlay.classList.add('active');
      const img = megaphoneOverlay.querySelector('img');
      img.style.animation = 'none';
      void img.offsetWidth;
      img.style.animation = 'megaphoneAnnounce 1.6s ease-out forwards';
      clearTimeout(playMegaphone._timer);
      playMegaphone._timer = setTimeout(() => {
        megaphoneOverlay.classList.remove('active');
      }, duration);
    }

    function playLightbulb(duration = 2000) {
      lightbulbOverlay.classList.add('active');
      const img = lightbulbOverlay.querySelector('img');
      img.style.animation = 'none';
      void img.offsetWidth;
      img.style.animation = 'lightbulbGlow 1.3s ease-out forwards';
      clearTimeout(playLightbulb._timer);
      playLightbulb._timer = setTimeout(() => {
        lightbulbOverlay.classList.remove('active');
      }, duration);
    }

    // 立即取消所有动画覆盖层与定时器
    function stopAllAnimations() {
      try {
        // 清除定时器
        if (playRainstorm._timer) clearTimeout(playRainstorm._timer);
        if (playPolicyFlag._timer) clearTimeout(playPolicyFlag._timer);
        if (playPolicyStamp._timer) clearTimeout(playPolicyStamp._timer);
        if (playSnow._timer) clearTimeout(playSnow._timer);
        if (playTruck._timer) clearTimeout(playTruck._timer);
        if (playChart._timer) clearTimeout(playChart._timer);
        if (playFactory._timer) clearTimeout(playFactory._timer);
        if (playMegaphone._timer) clearTimeout(playMegaphone._timer);
        if (playLightbulb._timer) clearTimeout(playLightbulb._timer);

        // 移除激活状态
        rainOverlay.classList.remove('active');
        flagOverlay.classList.remove('active');
        stampOverlay.classList.remove('active');
        snowOverlay.classList.remove('active');
        truckOverlay.classList.remove('active');
        chartOverlay.classList.remove('active');
        factoryOverlay.classList.remove('active');
        megaphoneOverlay.classList.remove('active');
        lightbulbOverlay.classList.remove('active');

        // 重置动画样式，确保立刻停止
        const imgFlag = flagOverlay.querySelector('img');
        if (imgFlag) imgFlag.style.animation = 'none';
        const stamp = stampOverlay.querySelector('.stamp');
        if (stamp) stamp.style.animation = 'none';
        const imgTruck = truckOverlay.querySelector('img');
        if (imgTruck) imgTruck.style.animation = 'none';
        const imgChart = chartOverlay.querySelector('img');
        if (imgChart) imgChart.style.animation = 'none';
        const imgFactory = factoryOverlay.querySelector('img');
        if (imgFactory) imgFactory.style.animation = 'none';
        const imgMegaphone = megaphoneOverlay.querySelector('img');
        if (imgMegaphone) imgMegaphone.style.animation = 'none';
        const imgLightbulb = lightbulbOverlay.querySelector('img');
        if (imgLightbulb) imgLightbulb.style.animation = 'none';

      } catch (err) {
        // 静默处理，避免关闭流程受阻
      }
    }

    // 渲染事件面板下方内容，显示所有发生过的事件（带时间线布局）
    function renderEventPanel() {
      // 添加淡出过渡效果
      eventPanelContent.classList.add('fade-out');
      
      setTimeout(() => {
        if (eventHistory.length > 0) {
          eventPanelContent.innerHTML = `
            <div class="event-timeline">
              ${eventHistory.map((item, i) => 
                `<div class="event-timeline-item">
                  <div class="event-item-container">
                    <div class="event-month-box">
                      <div class="event-month-label">Month</div>
                      <div class="event-month-value">${item.round}</div>
                    </div>
                    <div class="event-history-item" onclick="showEventModalFromPanel(${item.eventIndex})">
                      <div class="event-list-item">${events[item.eventIndex].title}</div>
                      <div class="event-list-effect">${events[item.eventIndex].effect}</div>
                    </div>
                  </div>
                </div>`
              ).join('')}
            </div>
          `;
          
          // 添加平滑滚动行为
          eventPanelContent.style.scrollBehavior = 'smooth';
          
          // 滚动到最新事件
          setTimeout(() => {
            const timelineItems = eventPanelContent.querySelectorAll('.event-timeline-item');
            if (timelineItems.length > 0) {
              timelineItems[timelineItems.length - 1].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }, 100);
        } else {
          // 初始空白状态
          eventPanelContent.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:40px 20px; color:#6c757d; text-align:center;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#adb5bd" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:12px;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              <div style="font-size:14px; font-weight:500; margin-bottom:4px;">No Events</div>
              <div style="font-size:12px; opacity:0.7;">Event records will be displayed during gameplay</div>
            </div>
          `;
        }
        
        // 添加淡入过渡效果
        eventPanelContent.classList.remove('fade-out');
        eventPanelContent.classList.add('fade-in');
      }, 150);
    }
    // 供面板点击标题时调用
    window.showEventModalFromPanel = function(idx) {
      showEventModal(idx);
    };

    // 事件历史索引
    let eventHistory = [];

    // 每回合弹出事件浮窗
    function nextEvent() {
      lastEventIndex = eventIndex;

      const availableEventIndices = events
        .map((_, idx) => idx)
        .filter(idx => !appearedEvents.includes(idx));

      if (availableEventIndices.length === 0) {
        // 所有事件都已出现，可以根据需求决定是否重置或停止显示事件
        console.log("所有事件都已出现。");
        eventIndex = -1; // 或者重置 appearedEvents = []
        return;
      }

      const randomIndex = Math.floor(Math.random() * availableEventIndices.length);
      eventIndex = availableEventIndices[randomIndex];
      appearedEvents.push(eventIndex);

      eventHistory.push({ eventIndex: eventIndex, round: round });
      showEventModal(eventIndex);
    }
    // 首次显示空白
    renderEventPanel();

    confirmBtn.onclick = function() {
      prevPlantationPrice = plantationPrice; // 记录上一回合的种植园价格
      const num1 = Math.max(0, parseInt(input1.value) || 0); // 本回合输入1
      const num2 = Math.max(0, parseInt(input2.value) || 0); // 本回合输入2

      // 新增规则：Orders to Plantation和 Shipments to Consumers必须为正整数
      if (!Number.isInteger(parseFloat(input1.value))) {
        showEventModal(null, 'Operation Failed', 'Orders to Plantation must be a natural number (including 0).', 'Invalid Input');
        return;
      }
      if (!Number.isInteger(parseFloat(input2.value))) {
        showEventModal(null, 'Operation Failed', 'Shipments to Consumers must be a natural number (including 0).', 'Invalid Input');
        return;
      }

        // 检查发货量是否超过仓库库存
        if (num2 > warehouse) {
          showEventModal(null, 'Operation Failed', 'The quantity you set for shipment exceeds the current warehouse stock. Please adjust the quantity.', 'Insufficient Stock');
          return; // 阻止后续操作
        }

        round++;
        playerSellingPrice = parseFloat(document.getElementById('player-price-input').value) || 0; // 获取玩家设置的销售价格

      // 更新上一回合订单量和发货量


      // 仓库 = 原有仓库 + 上一回合发货量
      warehouse = Math.round(warehouse + prevRoundShipmentForWarehouse);

      // 发货量 = 本回合的订单量
      shipment = num1;

      // 保存本回合的发货量，作为下一回合的入库量
      prevRoundShipmentForWarehouse = shipment;

      // 需求动态调整系统
      // 1. 产品生命周期需求曲线（基础需求计算）
      let baseDemand = 0;
      if (round >= 1 && round <= 5) {
        // 回合1-5: 200 × 1.2ⁿ
        baseDemand = 200 * Math.pow(1.2, round);
      } else if (round >= 6 && round <= 10) {
        // 回合6-10: 500 × 1.1ⁿ
        baseDemand = 500 * Math.pow(1.1, round - 5);
      } else if (round >= 11 && round <= 15) {
        // 回合11-15: 400 × 1.1ⁿ
        baseDemand = 400 * Math.pow(1.1, round - 10);
      } else if (round >= 16 && round <= 20) {
        // 回合16-20: 300 × 1.1ⁿ
        baseDemand = 300 * Math.pow(1.1, round - 15);
      } else {
        // 超出范围的处理
        baseDemand = 300 * Math.pow(1.05, round - 20);
      }
      
      // 2. 需求惩罚机制：库存为0时，未满足需求会留到下回合，需求下降30%
      let currentUnsatisfied = 0;
      if (warehouse === 0 && prevDemand > 0) {
        // 计算未满足的需求
        currentUnsatisfied = prevDemand - num2;
        if (currentUnsatisfied > 0) {
          unsatisfiedDemand += currentUnsatisfied;
          // 需求下降30%
          baseDemand *= 0.7;
        }
      } else {
        // 正常满足需求，重置未满足需求
        unsatisfiedDemand = 0;
      }
      
      // 3. 垄断惩罚机制：需求超过1500且长期不满足时，需求直接减少70%
      // 检查是否连续多回合需求高且未满足（使用上一回合的需求来判断）
      const hasInventoryButNotSell = warehouse > 0 && num2 < prevDemand; // 玩家有库存但不卖（垄断行为）
      const priceTooHigh = playerSellingPrice > 2.8; // 玩家价格过高（超过2.8 unit）
      
      if (prevDemand > 1500 && (unsatisfiedDemand > 0 || hasInventoryButNotSell || priceTooHigh)) {
        consecutiveUnsatisfiedRounds++;
        if (consecutiveUnsatisfiedRounds >= 3) {
          // 连续3回合需求超过1500且存在未满足需求/垄断行为/价格过高，触发垄断惩罚
          baseDemand *= 0.3; // 需求减少70%
          consecutiveUnsatisfiedRounds = 0; // 重置计数器
          
          // 显示垄断惩罚提示
          if (hasInventoryButNotSell) {
            showEventModal('垄断市场警告', '检测到您有库存但未充分满足市场需求！需求减少70%。', '需求大幅下降');
          } else if (priceTooHigh) {
            showEventModal('价格过高警告', '您的定价过高导致市场需求减少！需求减少70%。', '需求大幅下降');
          } else {
            showEventModal('需求未满足警告', '连续多回合未能满足市场需求！需求减少70%。', '需求大幅下降');
          }
        }
      } else {
        consecutiveUnsatisfiedRounds = 0; // 重置计数器
      }
      
      // 记录需求历史（在计算最终需求后记录）
      
      // 最终需求量 = 基础需求 + 上一回合未满足需求 - 当前发货量
      demand = Math.round(baseDemand + unsatisfiedDemand - num2);
      if (demand < 0) demand = 0;
      
      // 记录需求历史
      demandHistory.push(demand);
      if (demandHistory.length > 5) {
        demandHistory.shift(); // 只保留最近5回合
      }

      // 成本计算系统
      // 1. 基础成本：每回合100 unit（仓库租赁费）
      const baseCost = 50;
      
      // 2. 超额库存成本：库存超过400时，每超1单位增加0.25成本
      const excessInventoryCost = warehouse > 400 ? (warehouse - 400) * 0.25 : 0;
      
      // 3. 采购成本：玩家购买咖啡豆的成本 = 订单量 * 种植园价格
      const purchaseCost = num1 * prevPlantationPrice;
      
      // 总成本 = 基础成本 + 超额库存成本 + 采购成本
      const totalCost = baseCost + excessInventoryCost + purchaseCost;
      currentBaseCost = baseCost;
      currentExcessInventoryCost = excessInventoryCost;
      currentPurchaseCost = purchaseCost;
      
      // 更新累计成本
      cost += totalCost;

      // 种植园销售价格逻辑（基于需求量分段调整）
      if (demand >= 0 && demand <= 200) {
        // 需求量 0-200: 初始0.5unit，每减少50需求，价格减少0.1unit
        const decreaseSteps = Math.floor((200 - demand) / 50);
        plantationPrice = 0.5 - (decreaseSteps * 0.1);
      } else if (demand > 200 && demand <= 300) {
        // 需求量 200-300: 初始0.5unit，每增加50需求，价格增加0.1unit
        const increaseSteps = Math.floor((demand - 200) / 50);
        plantationPrice = 0.5 + (increaseSteps * 0.1);
      } else if (demand > 300 && demand <= 600) {
        // 需求量 300-600: 每增加50需求，价格增加0.1unit
        const increaseSteps = Math.floor((demand - 300) / 50);
        plantationPrice = 0.7 + (increaseSteps * 0.1); // 300需求时价格为0.7
      } else if (demand > 600 && demand <= 900) {
        // 需求量 700-900: 每增加100需求，价格增加0.05unit
        const increaseSteps = Math.floor((demand - 600) / 100);
        plantationPrice = 1.3 + (increaseSteps * 0.05); // 600需求时价格为1.3
      } else if (demand > 900 && demand <= 1000) {
        // 需求量 900-1000: 固定价格1.55unit
        plantationPrice = 1.55;
      } else {
        // 超出范围的价格处理
        plantationPrice = Math.max(0.1, Math.min(1.55, plantationPrice));
      }
      
      // 消费者价格接受区间逻辑
      let acceptanceRate = 100;
      let priceRangeText = "";
      
      if (demand <= 200) { // 低需求量区间
        if (playerSellingPrice <= 2.0) {
          acceptanceRate = 100;
          priceRangeText = "0 - 2.0 unit (100% Acceptance)";
        } else if (playerSellingPrice <= 3.0) {
          acceptanceRate = 100 - ((playerSellingPrice - 2.0) / (3.0 - 2.0)) * 100;
          priceRangeText = "2.0 - 3.0 unit (Linear Decline)";
        } else {
          acceptanceRate = 0;
          priceRangeText = "> 3.0 unit (0% Acceptance)";
        }
      } else if (demand <= 600) { // 中需求量区间
        if (playerSellingPrice <= 3.0) {
          acceptanceRate = 100;
          priceRangeText = "0 - 3.0 unit (100% Acceptance)";
        } else if (playerSellingPrice <= 4.5) {
          acceptanceRate = 100 - ((playerSellingPrice - 3.0) / (4.5 - 3.0)) * 100;
          priceRangeText = "3.0 - 4.5 unit (Linear Decline)";
        } else {
          acceptanceRate = 0;
          priceRangeText = "> 4.5 unit (0% Acceptance)";
        }
      } else { // 高需求量区间
        if (playerSellingPrice <= 4.0) {
          acceptanceRate = 100;
          priceRangeText = "0 - 4.0 unit (100% Acceptance)";
        } else if (playerSellingPrice <= 6.0) {
          acceptanceRate = 100 - ((playerSellingPrice - 4.0) / (6.0 - 4.0)) * 100;
          priceRangeText = "4.0 - 6.0 unit (Linear Decline)";
        } else {
          acceptanceRate = 0;
          priceRangeText = "> 6.0 unit (0% Acceptance)";
        }
      }
      acceptanceRate = Math.max(0, Math.min(100, acceptanceRate)); // 确保接受率在0-100之间
      
      // 更新消费者价格区间显示
      document.getElementById('consumer-price-range').textContent = priceRangeText;
      document.getElementById('consumer-acceptance').textContent = Math.round(acceptanceRate) + '%';
      
      // 玩家收入动态计算逻辑（考虑接受度）
      // 收入 = (玩家销售价格 - 种植园价格) * 实际发货量 * 接受度百分比
      const actualShipment = Math.min(num2, warehouse); // 实际发货量不能超过库存
      const effectiveShipment = actualShipment * (acceptanceRate / 100); // 考虑接受度的有效发货量
      warehouse = Math.round(warehouse - effectiveShipment); // 更新仓库库存：原有库存 + 本回合生产 - 有效发货量
      playerIncome = playerSellingPrice * effectiveShipment;

      historyArr.push({order: num1, shipment: num2, income: playerIncome, cost: totalCost});
      profitMarginPerUnit = playerSellingPrice - prevPlantationPrice;
      actualShipmentQuantity = actualShipment;
      effectiveAcceptanceRate = acceptanceRate;
      
      // 更新玩家资金
      // 玩家资金变化 = 收入 - 当前回合总成本
      playerMoney += playerIncome - totalCost;

      // 保存本回合发货量和需求量，供下回合用
      prevShipment = shipment;
      prevDemand = demand;

      // 动态计算风险值
      updateRiskValues();

      updateDisplay();
      input1.value = 0;
      input2.value = 0;

      if (round > maxRound) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Game Over';
        confirmBtn.style.background = '#aaa';
      }
      if (round >= 4 && (round - 4) % 2 === 0) { // 从第四回合开始，每隔两个回合出现一个事件
        nextEvent(); // 在回合推进时切换事件
      }
    };
    // 初始化显示
    updateDisplay();

    // ChatGPT风格AI助手对话逻辑
    const aiChatContent = document.getElementById('ai-chat-content');
    const aiInput = document.getElementById('ai-input');
    const aiSendBtn = document.getElementById('ai-send-btn');
    function appendAIMessage(text, sender) {
      const row = document.createElement('div');
      row.className = 'ai-game-msg-row ' + sender;
      const avatar = document.createElement('div');
      avatar.className = 'ai-game-msg-avatar ' + sender;
      avatar.innerHTML = sender === 'ai' ? '<svg width="22" height="22" viewBox="0 0 22 22"><circle cx="11" cy="11" r="11" fill="#2c2c2c"/><text x="50%" y="56%" text-anchor="middle" fill="#fff" font-size="11" font-family="Arial" dy=".3em">AI</text></svg>' : '<svg width="22" height="22" viewBox="0 0 22 22"><circle cx="11" cy="11" r="11" fill="#bdbdbd"/><text x="50%" y="56%" text-anchor="middle" fill="#fff" font-size="11" font-family="Arial" dy=".3em">Me</text></svg>';
      const bubble = document.createElement('div');
      bubble.className = 'ai-game-msg-bubble ' + sender;
      bubble.textContent = text;
      row.appendChild(avatar);
      row.appendChild(bubble);
      if (sender === 'user') row.appendChild(avatar);
      aiChatContent.appendChild(row);
      aiChatContent.scrollTop = aiChatContent.scrollHeight;
    }
    const GAME_RULES = `You are an AI assistant for a coffee supply chain simulation game. The game has the following core logic:\n- The game has three main modules: "Plantation", "Distributor Warehouse", and "Consumers".\n- Main variables include: Warehouse (inventory), Shipment (goods sent in the current round), and Demand (consumer demand).\n- Each round, users can input order quantities to the plantation and shipment quantities to consumers.\n- Warehouse = Previous warehouse + Previous round shipment - Previous round demand.\n- Shipment = Order quantity input in the current round.\n- Demand = 200*(1+20%)^n + Previous round demand - Current round shipment (where n is the current round number).\n- Costs are related to warehouse inventory; inventory above 400 will incur additional costs.\n- The game has an event system that may affect production, demand, etc.\nPlease help users make optimal decisions based on these rules and real-time page data.`;
    function getPageContext() {
      const warehouseValue = document.getElementById('warehouse-value')?.textContent || '';
      const shipmentValue = document.getElementById('shipment-value')?.textContent || '';
      const demandValue = document.getElementById('demand-value')?.textContent || '';
      const roundCounter = document.getElementById('round-counter')?.textContent || '';
      const coffeeBeanPrice = document.getElementById('coffee-bean-price')?.textContent || '';
      const consumerPriceRange = document.getElementById('consumer-price-range')?.textContent || '';
      const consumerAcceptance = document.getElementById('consumer-acceptance')?.textContent || '';
      const playerMoney = document.getElementById('player-money-display')?.textContent || '';
      const playerIncome = document.getElementById('player-income-display')?.textContent || '';
      const costValue = document.getElementById('cost-value')?.textContent || '';
      const plantationPrice = document.getElementById('plantation-price-display')?.textContent || '';
      const playerPrice = document.getElementById('player-price-display')?.textContent || '';
      const input1Value = document.getElementById('input1')?.value || '';
      const input2Value = document.getElementById('input2')?.value || '';
      const playerPriceInputValue = document.getElementById('player-price-input')?.value || '';

      const contextData = {
        round: roundCounter,
        coffeeBeanPrice: coffeeBeanPrice,
        shipment: shipmentValue,
        warehouse: warehouseValue,
        demand: demandValue,
        consumerPriceRange: consumerPriceRange,
        consumerAcceptance: consumerAcceptance,
        playerMoney: playerMoney,
        playerIncome: playerIncome,
        cost: costValue,
        plantationPrice: plantationPrice,
        playerPrice: playerPrice,
        ordersToPlantation: input1Value,
        shipmentsToConsumers: input2Value,
        playerSellingPriceInput: playerPriceInputValue
      };
      return JSON.stringify(contextData);
    }
    aiSendBtn.onclick = async function() {
      const userText = aiInput.value.trim();
      if (!userText) return;
      // 拼接页面数据上下文
      const context = getPageContext();
      const fullPrompt = context + '\nUser question: ' + userText;
      appendAIMessage(userText, 'user');
      aiInput.value = '';
      aiSendBtn.disabled = true;
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk-855605ce52804d2b8b928ce8d7b43679'
          },
          body: JSON.stringify({
            model: 'qwen-max',
            messages: [
              { role: 'system', content: '你是一个专注于供应链商业模拟的智能顾问。你的职责是引导玩家提升决策能力，而非直接提供解决方案。请通过提出关键问题、分析当前数据、预测潜在结果，以及建议玩家关注的重点，来启发玩家独立思考。你的回应应力求简洁、高效，以最少的文字提供最大的指导价值，避免直接给出操作指令或最优解。' },
              { role: 'system', content: GAME_RULES },
              { role: 'user', content: fullPrompt }
            ]
          })
        });
        const data = await response.json();
        const aiReply = data.choices?.[0]?.message?.content || 'Sorry, I cannot answer at the moment.';
        appendAIMessage(aiReply, 'ai');
      } catch (e) {
        appendAIMessage('Request failed, please try again later.', 'ai');
      }
      aiSendBtn.disabled = false;
    };
    aiInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') aiSendBtn.onclick();
    });

    // 游戏结束时生成总结图表
    function showSummaryCharts() {
      // 隐藏底部UI元素
      const bottomElements = document.querySelectorAll('.bottom-row-flex, .event-panel, .panel, .ai-panel');
      bottomElements.forEach(element => {
        element.style.display = 'none';
      });
      
      // 显示结算页面
      document.getElementById('summary-modal').style.display = 'flex';
      
      // 构造数据
      const rounds = Array.from({length: historyArr.length}, (_, i) => i+1);
      // 仓库、发货量、需求量、成本
      const warehouseList = window._warehouseHistory || [];
      const shipmentList = historyArr.map(item => item.shipment);
      const demandList = window._demandHistory || [];
      const costList = window._costHistory || [];
      const incomeList = (window._incomeHistory && window._incomeHistory.length) ? window._incomeHistory : historyArr.map(item => item.income || 0);
      const acceptList = window._acceptanceHistory || [];
      const priceList = window._sellingPriceHistory || [];
      const sum = arr => arr.reduce((a,b)=>a + (isFinite(b) ? b : 0), 0);
      const totalRevenue = sum(incomeList);
      const totalCost = sum(costList);
      const totalProfit = totalRevenue - totalCost;
      const avgPrice = priceList.length ? (sum(priceList) / priceList.length) : 0;
      const avgAccept = acceptList.length ? (sum(acceptList) / acceptList.length) : 0;
      const totalShipments = sum(shipmentList);
      const peakDemand = demandList.length ? Math.max.apply(null, demandList) : 0;
      const finalWarehouse = warehouseList.length ? warehouseList[warehouseList.length - 1] : 0;
      const profitList = rounds.map((_, i) => (incomeList[i] || 0) - (costList[i] || 0));
      const cumulativeProfitList = profitList.map((v, i) => profitList.slice(0, i+1).reduce((a,b)=>a+b, 0));
      const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      setText('kpi-revenue', totalRevenue.toFixed(2));
      setText('kpi-cost', totalCost.toFixed(2));
      setText('kpi-profit', totalProfit.toFixed(2));
      setText('kpi-avg-price', avgPrice.toFixed(2));
      setText('kpi-avg-accept', (avgAccept).toFixed(2) + '%');
      setText('kpi-shipments', totalShipments.toFixed(0));
      setText('kpi-peak-demand', peakDemand.toFixed(0));
      setText('kpi-final-warehouse', finalWarehouse.toFixed(0));
      
      if (window.echarts) {
        const chartInstances = {}; // Store chart instances

        // Initialize all charts
        const initChart = (id, option) => {
          const chartDom = document.getElementById(id);
          if (chartDom) {
            const chart = window.echarts.init(chartDom);
            chart.setOption(option);
            chartInstances[id] = chart;
          }
        };

        initChart('echarts1', {
          title: { text: 'Warehouse Inventory/Shipment/Demand', left: 'center', top: 0, textStyle: { fontSize: 15 } },
          tooltip: { trigger: 'axis' },
          legend: { data: ['Warehouse Inventory','Shipment','Demand'], top: 28 },
          xAxis: { type: 'category', data: rounds, name: 'Round' },
          yAxis: { type: 'value', name: 'Quantity' },
          series: [
            { name: 'Warehouse Inventory', type: 'line', data: warehouseList, smooth: true },
            { name: 'Shipment', type: 'line', data: shipmentList, smooth: true },
            { name: 'Demand', type: 'line', data: demandList, smooth: true }
          ]
        });
        
        initChart('echarts2', {
          title: { text: 'Cost per Round', left: 'center', top: 0, textStyle: { fontSize: 15 } },
          tooltip: { trigger: 'axis' },
          legend: { data: ['Cost'], top: 28 },
          xAxis: { type: 'category', data: rounds, name: 'Round' },
          yAxis: { type: 'value', name: 'Cost' },
          series: [
            { name: 'Cost', type: 'line', data: costList, smooth: true }
          ]
        });

        initChart('echarts3', {
          title: { text: 'Revenue vs Cost with Profit', left: 'center', top: 0, textStyle: { fontSize: 15 } },
          tooltip: { trigger: 'axis' },
          legend: { data: ['Revenue','Cost','Profit'], top: 28 },
          xAxis: { type: 'category', data: rounds, name: 'Round' },
          yAxis: { type: 'value', name: 'Value' },
          series: [
            { name: 'Revenue', type: 'bar', data: incomeList },
            { name: 'Cost', type: 'bar', data: costList },
            { name: 'Profit', type: 'line', data: profitList, smooth: true }
          ]
        });

        initChart('echarts4', {
          title: { text: 'Cumulative Profit', left: 'center', top: 0, textStyle: { fontSize: 15 } },
          tooltip: { trigger: 'axis' },
          legend: { data: ['Cumulative Profit'], top: 28 },
          xAxis: { type: 'category', data: rounds, name: 'Round' },
          yAxis: { type: 'value', name: 'Profit' },
          series: [
            { name: 'Cumulative Profit', type: 'line', data: cumulativeProfitList, smooth: true }
          ]
        });

        // Tab switching logic
        const chartTabs = document.querySelectorAll('.chart-tab-btn');
        const chartPanels = document.querySelectorAll('.chart-panel');

        function showChart(chartId) {
          chartPanels.forEach(panel => panel.classList.remove('active'));
          chartTabs.forEach(tab => tab.classList.remove('active'));

          const activePanel = document.getElementById(chartId);
          if (activePanel) {
            activePanel.classList.add('active');
            const activeTab = document.querySelector(`.chart-tab-btn[data-chart="${chartId}"]`);
            if (activeTab) {
              activeTab.classList.add('active');
            }
            // Resize the chart to ensure it renders correctly when it becomes visible
            if (chartInstances[chartId]) {
              chartInstances[chartId].resize();
            }
          }
        }

        chartTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const chartId = tab.getAttribute('data-chart');
            showChart(chartId);
          });
        });

        // Show the first chart by default
        showChart('echarts1');
      }
    }
    // 记录每回合仓库、需求、成本历史
    window._warehouseHistory = [];
    window._demandHistory = [];
    window._costHistory = [];
    window._incomeHistory = [];
    window._acceptanceHistory = [];
    window._sellingPriceHistory = [];
    window._baseCostHistory = [];
    window._excessInventoryCostHistory = [];
    window._purchaseCostHistory = [];
    // 在每回合确认时记录
    const oldConfirm = confirmBtn.onclick;
    confirmBtn.onclick = function() {
      oldConfirm && oldConfirm.call(this);
      window._warehouseHistory.push(warehouse);
      window._demandHistory.push(demand);
      window._costHistory.push(cost);
      window._incomeHistory.push(playerIncome);
      window._acceptanceHistory.push(effectiveAcceptanceRate);
      window._sellingPriceHistory.push(playerSellingPrice);
      window._baseCostHistory.push(currentBaseCost);
      window._excessInventoryCostHistory.push(currentExcessInventoryCost);
      window._purchaseCostHistory.push(currentPurchaseCost);
      checkGameEnd();
    };
    // 游戏结束时弹窗
    function checkGameEnd() {
      if (round > maxRound) {
        showSummaryCharts();
      }
    }
    // 在原有confirmBtn.onclick后加checkGameEnd

    // 关闭弹窗只能点右上角
    document.getElementById('summary-close').onclick = function() {
      document.getElementById('summary-modal').style.display = 'none';
      // 恢复底部UI元素的显示
      const bottomElements = document.querySelectorAll('.bottom-row-flex, .event-panel, .panel, .ai-panel');
      bottomElements.forEach(element => {
        element.style.display = '';
      });
    };
    // 禁止点击遮罩关闭
    document.getElementById('summary-modal').onclick = function(e) {
      // do nothing
    };
  </script>

  <div id="rules-modal" style="display: none; position: fixed; left: 0; top: 0; right: 0; bottom: 0; z-index: 3000; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 24px; max-width: 760px; width: 92vw; max-height: 86vh; overflow: auto; position: relative;">
      <button onclick="hideRulesModal()" style="position: absolute; top: 12px; right: 12px; background: #f8f9fa; border: 1px solid #e9ecef; font-size: 1.2rem; color: #6c757d; cursor: pointer; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">×</button>
      <h3 style="margin: 0 0 16px 0; color: #2c2c2c; font-size: 1.3rem; border-bottom: 2px solid #ffdaa6; padding-bottom: 8px;">规则说明</h3>
      <div style="font-size: 0.95rem; line-height: 1.7; color: #495057;">
        <p>目标：在 20 回合内通过合理下单、定价与发货，最大化累计利润并稳定关键指标。</p>
        <h4 style="margin: 14px 0 8px; color:#2c2c2c; font-size: 1.05rem;">操作与回合流程</h4>
        <ul style="margin:0 0 12px 0; padding-left: 20px;">
          <li>输入下单量、发货量与销售价格，点击确认推进回合。</li>
          <li>校验：发货不可超过当前库存，输入需为自然数或合法数值。</li>
          <li>库存更新：先加上上一回合到库，再扣除本回合有效发货。</li>
          <li>需求更新：按生命周期曲线变化；未满足需求会累积并影响后续需求。</li>
          <li>结算：计算接受度、有效发货、收入与成本，并更新风险与历史。</li>
        </ul>
        <h4 style="margin: 14px 0 8px; color:#2c2c2c; font-size: 1.05rem;">需求与定价</h4>
        <ul style="margin:0 0 12px 0; padding-left: 20px;">
          <li>生命周期曲线：前期增长快，中期平稳，后期趋缓。</li>
          <li>接受度：根据需求映射低/中/高三个价格区间；区间内 100% 接受，区间外线性下降。</li>
          <li>惩罚：库存为零且连续未满足需求时，下一回合需求按比例下降；高价或长期不售会触发垄断惩罚。</li>
        </ul>
        <h4 style="margin: 14px 0 8px; color:#2c2c2c; font-size: 1.05rem;">成本结构</h4>
        <ul style="margin:0 0 12px 0; padding-left: 20px;">
          <li>基准成本：每回合固定基础费用。</li>
          <li>超额库存成本：库存超过阈值按单位计提额外成本。</li>
          <li>采购成本：本回合下单量 × 上一回合种植园价格（随需求阶梯变化）。</li>
        </ul>
        <h4 style="margin: 14px 0 8px; color:#2c2c2c; font-size: 1.05rem;">风险与事件</h4>
        <ul style="margin:0 0 12px 0; padding-left: 20px;">
          <li>风险由库存/发货匹配、进度、成本压力与需求波动综合评估。</li>
          <li>从第 4 回合起，每隔两回合可能触发一次随机事件，影响成本或补库节奏。</li>
        </ul>
        <h4 style="margin: 14px 0 8px; color:#2c2c2c; font-size: 1.05rem;">结束与计分</h4>
        <ul style="margin:0 0 12px 0; padding-left: 20px;">
          <li>超过 20 回合后结束游戏，展示总收入、总成本、总利润等 KPI 与图表。</li>
          <li>策略要点：避免连续缺货与过度库存；价格尽量落在接受区间内以保证转化。</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    function showRulesModal(){
      document.getElementById('rules-modal').style.display='flex';
    }
    function hideRulesModal(){
      document.getElementById('rules-modal').style.display='none';
    }
    (function(){
      var mask=document.getElementById('rules-modal');
      if(mask){
        mask.addEventListener('click',function(e){ if(e.target===mask){ hideRulesModal(); } });
      }
      var btn=document.getElementById('rules-btn');
      if(btn){ btn.onclick=function(){ showRulesModal(); }; }
      document.addEventListener('keydown',function(e){ if(e.key==='Escape'){ hideRulesModal(); } });
    })();
  </script>
  
  <!-- 咖啡豆价格逻辑弹窗 -->
  <div id="plantation-price-modal" style="display: none; position: fixed; left: 0; top: 0; right: 0; bottom: 0; z-index: 3000; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 24px; max-width: 500px; width: 90vw; max-height: 80vh; overflow: auto; position: relative;">
      <button onclick="hidePlantationPriceLogic()" style="position: absolute; top: 12px; right: 12px; background: #f8f9fa; border: 1px solid #e9ecef; font-size: 1.2rem; color: #6c757d; cursor: pointer; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">×</button>
      <h3 style="margin: 0 0 16px 0; color: #2c2c2c; font-size: 1.3rem; border-bottom: 2px solid #ffdaa6; padding-bottom: 8px;">Coffee Bean Price Change Logic</h3>
      <div style="font-size: 0.95rem; line-height: 1.6; color: #495057;">
        <p style="margin: 0 0 12px 0;"><strong>Plantation price dynamically adjusts based on demand:</strong></p>
        <ul style="margin: 0 0 16px 0; padding-left: 20px;">
          <li style="margin-bottom: 8px;"><strong>0-200 Demand:</strong>Initial 0.5 unit, price decreases 0.1 unit for every 50 demand decrease</li>
          <li style="margin-bottom: 8px;"><strong>200-300 Demand:</strong>Initial 0.5 unit, price increases 0.1 unit for every 50 demand increase</li>
          <li style="margin-bottom: 8px;"><strong>300-600 Demand:</strong>Price increases 0.1 unit for every 50 demand increase (price at 300 demand is 0.7)</li>
          <li style="margin-bottom: 8px;"><strong>600-900 Demand:</strong>Price increases 0.05 unit for every 100 demand increase (price at 600 demand is 1.3)</li>
          <li style="margin-bottom: 8px;"><strong>900-1000 Demand:</strong>Fixed price 1.55 unit</li>
        </ul>
        <p style="margin: 0; font-style: italic; color: #6c757d;">Price Range: 0.1 - 1.55 unit</p>
      </div>
    </div>
  </div>

  <script>
    // 显示咖啡豆价格逻辑弹窗
    function showPlantationPriceLogic() {
      document.getElementById('plantation-price-modal').style.display = 'flex';
    }
    
    // 隐藏咖啡豆价格逻辑弹窗
    function hidePlantationPriceLogic() {
      document.getElementById('plantation-price-modal').style.display = 'none';
    }
    
    // 点击遮罩层关闭弹窗
    document.getElementById('plantation-price-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        hidePlantationPriceLogic();
      }
    });
    
    // ESC键关闭弹窗
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hidePlantationPriceLogic();
      }
    });
  </script>

  <!-- 消费者价格范围说明弹窗 -->
  <div id="consumer-price-range-modal" style="display: none; position: fixed; left: 0; top: 0; right: 0; bottom: 0; z-index: 3000; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 24px; max-width: 500px; width: 90vw; max-height: 80vh; overflow: auto; position: relative;">
      <button onclick="hideConsumerPriceRangeInfo()" style="position: absolute; top: 12px; right: 12px; background: #f8f9fa; border: 1px solid #e9ecef; font-size: 1.2rem; color: #6c757d; cursor: pointer; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">×</button>
      <h3 style="margin: 0 0 16px 0; color: #2c2c2c; font-size: 1.3rem; border-bottom: 2px solid #ffdaa6; padding-bottom: 8px;">Consumer Price Acceptance Range</h3>
      <div style="font-size: 0.95rem; line-height: 1.6; color: #495057;">
        <p style="margin: 0 0 12px 0;"><strong>Consumers have different price acceptance ranges based on market conditions:</strong></p>
        <ul style="margin: 0 0 16px 0; padding-left: 20px;">
          <li style="margin-bottom: 8px;">Consumers will accept different price ranges depending on market demand levels</li>
          <li style="margin-bottom: 8px;">The acceptable price range may change as the game progresses</li>
          <li style="margin-bottom: 8px;">Higher demand levels generally allow for higher price acceptance</li>
          <li style="margin-bottom: 8px;">Setting prices within the acceptable range ensures 100% consumer acceptance</li>
          <li style="margin-bottom: 8px;">Prices outside the acceptable range will result in reduced consumer purchases</li>
        </ul>
        <p style="margin: 0; font-style: italic; color: #6c757d;">Discover the optimal pricing strategy through gameplay experience!</p>
      </div>
    </div>
  </div>

  <script>
    // 显示消费者价格范围说明弹窗
    function showConsumerPriceRangeInfo() {
      document.getElementById('consumer-price-range-modal').style.display = 'flex';
    }
    
    // 隐藏消费者价格范围说明弹窗
    function hideConsumerPriceRangeInfo() {
      document.getElementById('consumer-price-range-modal').style.display = 'none';
    }
    
    // 点击遮罩层关闭弹窗
    document.getElementById('consumer-price-range-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideConsumerPriceRangeInfo();
      }
    });
    
    // ESC键关闭弹窗
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideConsumerPriceRangeInfo();
      }
    });
    
    // 页面加载时初始化回合计数器
    document.addEventListener('DOMContentLoaded', function() {
      updateRoundCounter();
    });
  </script>
</body>
</html>