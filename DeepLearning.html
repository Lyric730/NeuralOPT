<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Business Simulation System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Light Theme (Default) */
            --primary-bg: #f8f9fa;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --text-color: #333;
            --text-secondary: #666;
            --accent-color: #2c3e50;
            --highlight-color: #3498db;
            --border-color: rgba(255, 255, 255, 0.18);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --card-bg: #fff;
            --node-border: #fff;
        }

        [data-theme="dark"] {
            /* Dark / Cyberpunk Theme */
            --primary-bg: #0f0c29;
            --panel-bg: rgba(16, 20, 30, 0.85);
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-color: #00d2ff; /* Neon Cyan */
            --highlight-color: #3a7bd5;
            --border-color: rgba(0, 210, 255, 0.2);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --card-bg: #1a1f2e;
            --node-border: #00d2ff;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            /* Removed static image, will use Canvas */
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 1fr;
            grid-template-columns: 300px 1fr;
            grid-template-areas: 
                "header header"
                "left main";
            transition: background-color 0.5s, color 0.5s;
        }

        /* Particle Canvas */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Header */
        header {
            grid-area: header;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.5s;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .avatar {
            width: 32px;
            height: 32px;
            background: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        /* Panels */
        .panel {
            background: var(--panel-bg);
            backdrop-filter: blur(4px);
            border-radius: 15px;
            margin: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: background 0.5s, box-shadow 0.5s;
        }

        .left-panel {
            grid-area: left;
            margin-right: 0;
            z-index: 10;
        }

        h2 {
            font-size: 1.1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            color: var(--accent-color);
        }

        /* Modules List */
        .module-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, background 0.5s;
            border: 1px solid var(--border-color);
        }

        .module-item:hover {
            transform: translateY(-2px);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 1s ease-out;
        }

        /* Chat Interface */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .message.ai .bubble {
            background: var(--card-bg);
            color: var(--text-color);
            border-top-left-radius: 2px;
            border: 1px solid var(--border-color);
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message.user .bubble {
            background: var(--accent-color);
            color: #fff;
            border-top-right-radius: 2px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .bubble {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Typing cursor */
        .typing-cursor::after {
            content: '▋';
            display: inline-block;
            animation: blink 1s infinite;
            color: var(--accent-color);
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 20px;
            outline: none;
        }

        .chat-input button {
            background: var(--accent-color);
            color: #fff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }

        .chat-input button:hover {
            box-shadow: 0 0 15px var(--accent-color);
        }

        /* Main Canvas */
        #main-container {
            grid-area: main;
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .line {
            fill: none;
            stroke: var(--accent-color);
            stroke-width: 2;
            stroke-dasharray: 10;
            animation: flow 20s linear infinite;
            opacity: 0.6;
        }

        @keyframes flow {
            from { stroke-dashoffset: 1000; }
            to { stroke-dashoffset: 0; }
        }

        .orbit {
            fill: none;
            stroke: var(--text-secondary);
            stroke-width: 1;
            stroke-dasharray: 5, 5;
            opacity: 0.3;
            transform-origin: center;
            animation: rotateOrbit 60s linear infinite;
        }

        @keyframes rotateOrbit {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .node {
            position: absolute;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            z-index: 2;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #fff;
            border: 3px solid var(--node-border);
            /* Add bobbing animation */
            animation: floatNode 6s ease-in-out infinite;
        }

        @keyframes floatNode {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .node:hover {
            transform: scale(1.15) translateY(-5px);
            z-index: 10;
            box-shadow: 0 0 35px var(--accent-color);
        }

        .core {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, var(--accent-color) 0%, #000000 100%);
            font-weight: bold;
            font-size: 1.1em;
            /* Core pulse + float */
            animation: pulse 3s infinite, floatNode 8s ease-in-out infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(44, 62, 80, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(44, 62, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(44, 62, 80, 0); }
        }

        /* Dark mode pulse adjustment */
        [data-theme="dark"] .core {
             animation: pulseDark 3s infinite, floatNode 8s ease-in-out infinite;
        }

        @keyframes pulseDark {
            0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(0, 210, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); }
        }

        .branch {
            width: 110px;
            height: 110px;
            background: linear-gradient(135deg, #34495e 0%, var(--accent-color) 100%);
            font-size: 0.9em;
            padding: 5px;
        }

        .branch:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, #1a252f 100%);
        }

        /* Popups */
        .node .popup-content {
            display: none;
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background-color: var(--card-bg);
            color: var(--text-color);
            width: 240px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            text-align: left;
            cursor: default;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            border: 1px solid var(--border-color);
            pointer-events: none;
        }

        .node:hover .popup-content {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.9); }
            to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }

        .popup-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent-color);
            font-size: 1.1em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        .popup-content p {
            margin: 0;
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Arrow */
        .popup-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: var(--card-bg) transparent transparent transparent;
        }

        /* Detail Modal */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-overlay.active {
            display: flex;
            opacity: 1;
        }

        .detail-modal {
            background: var(--card-bg);
            width: 80%;
            height: 85%;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .detail-overlay.active .detail-modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--panel-bg) 0%, rgba(0,0,0,0.05) 100%);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--accent-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .modal-body {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }

        .content-section h3 {
            color: var(--highlight-color);
            margin-bottom: 15px;
            border-left: 4px solid var(--highlight-color);
            padding-left: 10px;
        }

        .content-card {
            background: var(--primary-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        /* Floating AI */
        .floating-ai-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .ai-window {
            width: 350px;
            height: 500px;
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: bottom right;
        }

        .ai-window.minimized {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
            height: 0;
            margin: 0;
        }

        .ai-header {
            padding: 15px;
            background: var(--accent-color);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move; /* Indicate draggable potential */
        }

        .ai-toggle-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--highlight-color) 0%, var(--accent-color) 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: transform 0.3s;
            position: relative;
            z-index: 2001;
        }

        .ai-toggle-btn:hover {
            transform: scale(1.1);
        }

        .ai-toggle-btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--highlight-color);
            animation: ripple 2s infinite;
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-network-wired"></i>
            DeepLearning Business Sim
        </div>
        <div class="user-profile">
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" id="theme-btn" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 15px; color: var(--text-color);">
                <i class="fas fa-moon"></i>
            </button>
            <span>Student User</span>
            <div class="avatar"><i class="fas fa-user"></i></div>
        </div>
    </header>

    <!-- Particle Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- Left Panel: Stats -->
    <aside class="panel left-panel">
        <h2><i class="fas fa-chart-line"></i> Learning Progress</h2>
        
        <!-- Default State -->
        <div id="stats-default" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #95a5a6;">
            <i class="fas fa-hand-pointer" style="font-size: 3em; margin-bottom: 20px; color: #bdc3c7;"></i>
            <p>Hover over nodes<br>to view details</p>
        </div>

        <!-- Module Stats (Hidden by default) -->
        <div class="module-item" id="stats-logistics" style="display: none;">
            <div class="module-header">
                <span>Logistics</span>
                <span style="color: #27ae60;">85%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 85%; background: #27ae60;"></div>
            </div>
            <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                <i class="fas fa-check-circle" style="color: #27ae60;"></i> Supply Chain Basics: Done<br>
                <i class="fas fa-check-circle" style="color: #27ae60;"></i> Inventory Mgmt: Done<br>
                <i class="far fa-circle"></i> Global Logistics: In Progress
            </p>
        </div>

        <div class="module-item" id="stats-production" style="display: none;">
            <div class="module-header">
                <span>Production</span>
                <span style="color: #f39c12;">45%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 45%; background: #f39c12;"></div>
            </div>
            <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                <i class="fas fa-check-circle" style="color: #f39c12;"></i> Production Planning: Done<br>
                <i class="far fa-circle"></i> Quality Control: Pending<br>
                <i class="far fa-circle"></i> Lean Production: Pending
            </p>
        </div>

        <div class="module-item" id="stats-finance" style="display: none;">
            <div class="module-header">
                <span>Finance</span>
                <span style="color: #e74c3c;">30%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 30%; background: #e74c3c;"></div>
            </div>
             <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                <i class="fas fa-check-circle" style="color: #e74c3c;"></i> Basic Accounting: Done<br>
                <i class="far fa-circle"></i> Financial Statements: Pending<br>
                <i class="far fa-circle"></i> Investment Decisions: Pending
            </p>
        </div>

        <div class="module-item" id="stats-marketing" style="display: none;">
            <div class="module-header">
                <span>Marketing</span>
                <span style="color: #3498db;">60%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 60%; background: #3498db;"></div>
            </div>
            <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                <i class="fas fa-check-circle" style="color: #3498db;"></i> Market Research: Done<br>
                <i class="fas fa-check-circle" style="color: #3498db;"></i> Marketing Strategy: Done<br>
                <i class="far fa-circle"></i> Brand Management: In Progress
            </p>
        </div>
        
        <div style="margin-top: auto; padding: 15px; background: #e8f4fd; border-radius: 8px; font-size: 0.9em; color: #3498db;">
            <i class="fas fa-info-circle"></i> Hint: Click nodes for a comprehensive report.
        </div>
    </aside>

    <!-- Main Canvas -->
    <main id="main-container">
        <svg id="connections"></svg>
        <div id="nodes-container"></div> <!-- Nodes will be injected here -->
    </main>

    <!-- Detail Overlay -->
    <div class="detail-overlay" id="detail-overlay">
        <div class="detail-modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">
                    <i class="fas fa-cube"></i> Module Title
                </div>
                <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Floating AI Assistant -->
    <div class="floating-ai-container">
        <div class="ai-window minimized" id="ai-window">
            <div class="ai-header">
                <span><i class="fas fa-robot"></i> AI Assistant</span>
                <span onclick="toggleAI()" style="cursor: pointer;"><i class="fas fa-minus"></i></span>
            </div>
            <div class="chat-window">
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">
                        <div class="avatar" style="width: 28px; height: 28px; font-size: 0.8em; margin-top: 5px;"><i class="fas fa-robot"></i></div>
                        <div class="bubble">Hello! I am your Business Simulation Assistant. Click the button in the bottom right to summon me anytime.</div>
                    </div>
                </div>
                <div class="chat-input" style="padding: 10px; border-top: 1px solid #eee;">
                    <input type="text" placeholder="Ask a question..." id="chat-input">
                    <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        <div class="ai-toggle-btn" onclick="toggleAI()">
            <i class="fas fa-comment-dots"></i>
        </div>
    </div>

<script>
    const container = document.getElementById('main-container');
    const nodesContainer = document.getElementById('nodes-container');
    const svg = document.getElementById('connections');

    // Data
    const branches = [
        { 
            id: 'logistics',
            title: "Logistics<br>(Management)", 
            desc: "<strong>Key Concepts:</strong><br>• Supply Chain Opt.<br>• Inventory Turnover<br>• Route Planning<br><br><em>Click for details</em>", 
            angle: 190,
            orbitScale: 0.55 // Inner orbit
        },
        { 
            id: 'production',
            title: "Production<br>(Management)", 
            desc: "<strong>Key Concepts:</strong><br>• Lean Production<br>• Quality Mgmt System<br>• Capacity Planning<br><br><em>Click for details</em>", 
            angle: 110,
            orbitScale: 0.75 // Middle orbit
        },
        { 
            id: 'finance',
            title: "Finance<br>(Management)", 
            desc: "<strong>Key Concepts:</strong><br>• Cash Flow Mgmt<br>• ROI Analysis<br>• Risk Control<br><br><em>Click for details</em>", 
            angle: 330,
            orbitScale: 0.95 // Outer orbit
        },
        { 
            id: 'marketing',
            title: "Marketing<br>(Management)", 
            desc: "<strong>Key Concepts:</strong><br>• 4P Marketing Theory<br>• User Persona<br>• Brand Positioning<br><br><em>Click for details</em>", 
            angle: 30,
            orbitScale: 0.75 // Middle orbit
        }
    ];

    // Theme Toggle Logic
    const themeBtn = document.getElementById('theme-btn');
    let isDarkMode = false;

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        if (isDarkMode) {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
            themeBtn.style.color = '#f1c40f'; // Sun color
        } else {
            document.documentElement.removeAttribute('data-theme');
            themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
            themeBtn.style.color = '#333';
        }
    }

    // Particle System
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 0.5;
            this.vy = (Math.random() - 0.5) * 0.5;
            this.size = Math.random() * 2 + 1;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;

            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }

        draw() {
            ctx.fillStyle = isDarkMode ? 'rgba(0, 210, 255, 0.5)' : 'rgba(44, 62, 80, 0.5)';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function initParticles() {
        particles = [];
        // Reduced particle count for a cleaner look
        for (let i = 0; i < 35; i++) {
            particles.push(new Particle());
        }
    }

    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
            p.update();
            p.draw();
            
            // REMOVED: Inter-particle connections to reduce visual noise ("purify")
            
            // Connect to mouse (interactive) - kept for subtle interactivity
            const dx = p.x - mouseX;
            const dy = p.y - mouseY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) { // Reduced interaction radius
                 ctx.beginPath();
                // Much more subtle lines
                ctx.strokeStyle = isDarkMode ? `rgba(0, 210, 255, ${0.15 - dist/1000})` : `rgba(44, 62, 80, ${0.15 - dist/1000})`;
                ctx.lineWidth = 0.5; // Thinner lines
                ctx.moveTo(p.x, p.y);
                ctx.lineTo(mouseX, mouseY);
                ctx.stroke();
            }
        });

        requestAnimationFrame(animateParticles);
    }

    let mouseX = 0, mouseY = 0;
    window.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
    });

    initParticles();
    animateParticles();

    // Content Data for Modal
    const moduleContent = {
        'logistics': `
            <div class="content-section" style="grid-column: 1 / -1;">
                <p class="lead" style="font-size: 1.1em; color: #555;">Logistics management is the vessel of business operations, determining the efficiency and cost of resource flow.</p>
            </div>
            <div class="content-section">
                <h3><i class="fas fa-truck-loading"></i> Core Knowledge System</h3>
                <div class="content-card">
                    <h4>1. Supply Chain Optimization</h4>
                    <p>Overall planning of procurement, production, inventory, and distribution through mathematical models and algorithms.</p>
                    <ul>
                        <li>Network Design & Facility Location</li>
                        <li>Demand Forecasting & Collaborative Planning</li>
                    </ul>
                </div>
                <div class="content-card">
                    <h4>2. Inventory Turnover</h4>
                    <p>A key indicator of inventory management efficiency. High turnover means efficient capital utilization.</p>
                    <div style="background: #eee; height: 10px; border-radius: 5px; margin-top: 5px; width: 100%;"><div style="width: 70%; background: #27ae60; height: 100%; border-radius: 5px;"></div></div>
                </div>
            </div>
            <div class="content-section">
                <h3><i class="fas fa-video"></i> Case Studies</h3>
                <div class="content-card" style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-play-circle" style="font-size: 3em; margin-bottom: 10px; color: #ddd;"></i>
                    <p>Video: Operations of a large e-commerce logistics center</p>
                </div>
                <div class="content-card">
                    <h4>Key Data Monitoring</h4>
                    <p>On-Time Delivery (OTD): <strong style="color: #27ae60;">98.5%</strong></p>
                    <p>Transportation Cost Ratio: <strong style="color: #f39c12;">12%</strong></p>
                </div>
            </div>
        `,
        'production': `
            <div class="content-section" style="grid-column: 1 / -1;">
                <p class="lead" style="font-size: 1.1em; color: #555;">Production management aims to maximize the efficiency of converting inputs into outputs.</p>
            </div>
            <div class="content-section">
                <h3><i class="fas fa-industry"></i> Operations Management</h3>
                <div class="content-card">
                    <h4>1. Lean Production</h4>
                    <p>Eliminate waste, continuous improvement. Core idea is "Just In Time".</p>
                </div>
                <div class="content-card">
                    <h4>2. Quality Management System (QMS)</h4>
                    <p>Activities to ensure product quality meets standards. e.g., Six Sigma.</p>
                </div>
            </div>
             <div class="content-section">
                <h3><i class="fas fa-tools"></i> Production Dashboard</h3>
                 <div class="content-card">
                    <p>Overall Equipment Effectiveness (OEE): <strong style="color: #f39c12;">82%</strong></p>
                    <p>Defect Rate: <strong style="color: #e74c3c;">0.5%</strong></p>
                </div>
            </div>
        `,
        'finance': `
             <div class="content-section" style="grid-column: 1 / -1;">
                <p class="lead" style="font-size: 1.1em; color: #555;">Financial management is the blood of business, creating value through fundraising, usage, and distribution of funds.</p>
            </div>
            <div class="content-section">
                <h3><i class="fas fa-chart-pie"></i> Financial Core</h3>
                <div class="content-card">
                    <h4>1. Cash Flow Management</h4>
                    <p>Cash is the lifeline. Manage accounts receivable and payable well.</p>
                </div>
                <div class="content-card">
                    <h4>2. Return on Investment (ROI)</h4>
                    <p>Key metric for evaluating investment efficiency.</p>
                </div>
            </div>
        `,
        'marketing': `
             <div class="content-section" style="grid-column: 1 / -1;">
                <p class="lead" style="font-size: 1.1em; color: #555;">Marketing is the bridge between business and consumers, creating and delivering value.</p>
            </div>
            <div class="content-section">
                <h3><i class="fas fa-bullhorn"></i> Marketing Strategy</h3>
                <div class="content-card">
                    <h4>1. 4P Marketing Theory</h4>
                    <p>Product, Price, Place, Promotion.</p>
                </div>
                <div class="content-card">
                    <h4>2. User Persona</h4>
                    <p>Building virtual models of target users based on data analysis.</p>
                </div>
            </div>
        `
    };

    function renderTree() {
        const width = container.clientWidth;
        const height = container.clientHeight;
        // Shift center slightly to the left (minus 50px) to balance composition with the right floating AI
        const centerX = (width / 2) - 50;
        const centerY = height / 2;
        
        // Elliptical Layout: Base radius
        const maxRadiusX = Math.min(width, height) * 0.45; 
        const maxRadiusY = Math.min(width, height) * 0.35; 

        // Clear existing
        svg.innerHTML = '';
        nodesContainer.innerHTML = '';

        // Add Orbital Rings (Background Decoration)
        // We define specific orbits that match our nodes plus some decorative ones
        const orbitScales = [0.35, 0.55, 0.75, 0.95]; // 0.35 is purely decorative/inner
        
        orbitScales.forEach((scale, index) => {
            const orbit = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
            orbit.setAttribute("class", "orbit");
            orbit.setAttribute("cx", centerX);
            orbit.setAttribute("cy", centerY);
            orbit.setAttribute("rx", maxRadiusX * scale);
            orbit.setAttribute("ry", maxRadiusY * scale);
            
            // Varied opacity and style
            orbit.style.opacity = 0.1 + (index * 0.05); // Outer rings slightly more visible
            if(index === 0) orbit.style.strokeDasharray = "2, 4"; // Inner ring dots
            
            // Alternate rotation direction and speed
            orbit.style.animationDirection = index % 2 === 0 ? 'normal' : 'reverse';
            orbit.style.animationDuration = `${50 + index * 25}s`; // Slower outer rings
            svg.appendChild(orbit);
        });

        // Core Node
        const core = document.createElement('div');
        core.className = 'node core';
        core.innerHTML = '<div>Business Core</div><div style="font-size:0.8em; font-weight:normal; margin-top: 5px;">Decision Making</div>';
        core.style.left = `${centerX - 70}px`;
        core.style.top = `${centerY - 70}px`;
        nodesContainer.appendChild(core);

        // Branches
        branches.forEach(branch => {
            const angleRad = branch.angle * (Math.PI / 180);
            
            // Calculate position based on specific orbit scale
            const rx = maxRadiusX * branch.orbitScale;
            const ry = maxRadiusY * branch.orbitScale;
            
            const x = centerX + rx * Math.cos(angleRad);
            const y = centerY + ry * Math.sin(angleRad);

            // Create Straight Line (Energy Beam)
            // Reverting from curved lines as per feedback that curves looked strange
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("class", "line");
            line.setAttribute("x1", centerX);
            line.setAttribute("y1", centerY);
            line.setAttribute("x2", x);
            line.setAttribute("y2", y);
            
            svg.appendChild(line);

            // Create Node
            const node = document.createElement('div');
            node.className = 'node branch';
            node.innerHTML = `
                ${branch.title}
                <div class="popup-content">
                    <h3>${branch.title.replace('<br>', ' ')}</h3>
                    <p>${branch.desc}</p>
                </div>
            `;
            // Center the node (55px is half of 110px width)
            node.style.left = `${x - 55}px`;
            node.style.top = `${y - 55}px`;
            
            // Add interaction
            node.onclick = () => {
                openModal(branch);
            };

            // Hover effects for Left Panel
            node.addEventListener('mouseenter', () => {
                showModuleStats(branch.id);
            });
            
            node.addEventListener('mouseleave', () => {
                resetModuleStats();
            });

            nodesContainer.appendChild(node);
        });
    }

    // Modal Logic
    const modalOverlay = document.getElementById('detail-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');

    function openModal(branch) {
        modalTitle.innerHTML = `<i class="fas fa-cube"></i> ${branch.title.replace('<br>', ' ')}`;
        
        // Inject content
        const content = moduleContent[branch.id] || '<p>No details available.</p>';
        modalContent.innerHTML = content;

        modalOverlay.classList.add('active');

        // Trigger AI welcome for this module
        setTimeout(() => {
            // Check if AI window is closed, if so, maybe pulse the button or just send message
            addMessage('ai', `You are viewing details for **${branch.title.replace('<br>', ' ')}**. Feel free to ask any questions!`);
            
            // Optional: Auto open AI if desired, but user might find it intrusive. 
            // Let's just make sure the button is visible.
        }, 500);
    }

    function closeModal() {
        modalOverlay.classList.remove('active');
    }

    // Close modal on outside click
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });

    // Floating AI Logic
    const aiWindow = document.getElementById('ai-window');
    
    function toggleAI() {
        aiWindow.classList.toggle('minimized');
    }

    // Initial render
    renderTree();

    // Re-render on resize
    window.addEventListener('resize', renderTree);

    // Chat Functionality
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');

    function sendMessage() {
        const text = chatInput.value.trim();
        if (text) {
            addMessage('user', text);
            chatInput.value = '';
            
            // Auto reply simulation
            setTimeout(() => {
                const replies = [
                    "Received! Analyzing data... That's a great question.",
                    "Based on the knowledge base, this concept is critical in business practice.",
                    "You can check the detailed cases in the relevant module to deepen your understanding.",
                    "Data shows that mastering this can improve decision efficiency by 20%."
                ];
                const randomReply = replies[Math.floor(Math.random() * replies.length)];
                typeWriterEffect(randomReply);
            }, 1000);
        }
    }

    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `
            ${type === 'ai' ? '<div class="avatar" style="width: 28px; height: 28px; font-size: 0.8em; margin-top: 5px;"><i class="fas fa-robot"></i></div>' : ''}
            <div class="bubble">${text}</div>
            ${type === 'user' ? '<div class="avatar" style="width: 28px; height: 28px; font-size: 0.8em; margin-top: 5px; background: #3498db"><i class="fas fa-user"></i></div>' : ''}
        `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function typeWriterEffect(text) {
        const div = document.createElement('div');
        div.className = `message ai`;
        // Create bubble with cursor
        div.innerHTML = `
            <div class="avatar" style="width: 28px; height: 28px; font-size: 0.8em; margin-top: 5px;"><i class="fas fa-robot"></i></div>
            <div class="bubble typing-cursor"></div>
        `;
        chatMessages.appendChild(div);
        
        const bubble = div.querySelector('.bubble');
        let i = 0;
        
        function type() {
            if (i < text.length) {
                bubble.innerText += text.charAt(i); // Use innerText to avoid HTML tag issues during typing
                i++;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                setTimeout(type, 30); // Typing speed
            } else {
                bubble.classList.remove('typing-cursor'); // Remove cursor when done
                // If text contained HTML (like <br>), we might want to set innerHTML at the end if we were typing raw text
                // But for simple text this is fine. For rich text, logic is more complex.
                // Let's assume simple text for auto-replies.
                bubble.innerHTML = text; 
            }
        }
        type();
    }

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // Left Panel Interaction Helpers
    function showModuleStats(id) {
        // Hide Default
        document.getElementById('stats-default').style.display = 'none';
        
        // Hide all modules
        document.querySelectorAll('.left-panel .module-item').forEach(el => {
            el.style.display = 'none';
        });

        // Show specific module
        const target = document.getElementById(`stats-${id}`);
        if (target) {
            target.style.display = 'block';
            // Add a small animation class if desired, or just show
            target.style.animation = 'fadeIn 0.3s';
        }
    }

    function resetModuleStats() {
        // Show Default
        document.getElementById('stats-default').style.display = 'flex';
        
        // Hide all modules
        document.querySelectorAll('.left-panel .module-item').forEach(el => {
            el.style.display = 'none';
        });
    }

</script>

</body>
</html>
